<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>二进制部署 kubernetes 集群 | ALAN</title><meta name="description" content="部署单 Master 集群集群规划 初始化服务器1234567891011121314151617181920212223242526272829303132333435# 1.关闭防火墙systemctl disable firewalld &amp;&amp; systemctl stop firewalld# 2.关闭 selinuxsed -i &#39;&#x2F;^SELINUX&#x3D;&#x2F;c SELINUX&#x3D;"><meta name="keywords" content="二进制部署 kubernetes 集群"><meta name="author" content="ALAN"><meta name="copyright" content="ALAN"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="二进制部署 kubernetes 集群"><meta name="twitter:description" content="部署单 Master 集群集群规划 初始化服务器1234567891011121314151617181920212223242526272829303132333435# 1.关闭防火墙systemctl disable firewalld &amp;&amp; systemctl stop firewalld# 2.关闭 selinuxsed -i &#39;&#x2F;^SELINUX&#x3D;&#x2F;c SELINUX&#x3D;"><meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="og:type" content="article"><meta property="og:title" content="二进制部署 kubernetes 集群"><meta property="og:url" content="https://rocc.top/2020/01/01/Kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%E9%9B%86%E7%BE%A4/"><meta property="og:site_name" content="ALAN"><meta property="og:description" content="部署单 Master 集群集群规划 初始化服务器1234567891011121314151617181920212223242526272829303132333435# 1.关闭防火墙systemctl disable firewalld &amp;&amp; systemctl stop firewalld# 2.关闭 selinuxsed -i &#39;&#x2F;^SELINUX&#x3D;&#x2F;c SELINUX&#x3D;"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2020-01-01T05:14:21.000Z"><meta property="article:modified_time" content="2020-05-30T22:58:05.503Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://rocc.top/2020/01/01/Kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%E9%9B%86%E7%BE%A4/"><link rel="prev" title="Kubeadm 部署 kubernetes v1.18.2 集群（腾讯云版）" href="https://rocc.top/2020/05/01/Kubeadm%20%E9%83%A8%E7%BD%B2%20kubernetes%20v1.18.2%20%E9%9B%86%E7%BE%A4/"><link rel="next" title="Docker 基础入门" href="https://rocc.top/2019/10/01/Docker%20%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://rocc.top/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"Press","message_next":"to bookmark this page"},"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: true,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/cc-001.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">9</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="https://download.rocc.top" target="_blank" rel="noopener"><i class="fa-fw fa fa-download"></i><span> Download</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#部署单-Master-集群"><span class="toc-number">1.</span> <span class="toc-text">部署单 Master 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化服务器"><span class="toc-number">1.1.</span> <span class="toc-text">初始化服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-docker"><span class="toc-number">1.2.</span> <span class="toc-text">部署 docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-etcd"><span class="toc-number">1.3.</span> <span class="toc-text">部署 etcd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#颁发证书"><span class="toc-number">1.4.</span> <span class="toc-text">颁发证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-etcd"><span class="toc-number">1.5.</span> <span class="toc-text">安装 etcd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-flannel-网络"><span class="toc-number">1.6.</span> <span class="toc-text">部署 flannel 网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Master-节点部署组件"><span class="toc-number">1.7.</span> <span class="toc-text">Master 节点部署组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#颁发证书-1"><span class="toc-number">1.8.</span> <span class="toc-text">颁发证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-apiserver-组件"><span class="toc-number">1.9.</span> <span class="toc-text">部署 apiserver 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-scheduler-组件"><span class="toc-number">1.10.</span> <span class="toc-text">部署 scheduler 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-controller-manager-组件"><span class="toc-number">1.11.</span> <span class="toc-text">部署 controller-manager 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-节点部署组件"><span class="toc-number">1.12.</span> <span class="toc-text">Node 节点部署组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-kubelet-组件"><span class="toc-number">1.13.</span> <span class="toc-text">部署 kubelet 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-kube-proxy-组件"><span class="toc-number">1.14.</span> <span class="toc-text">部署 kube-proxy 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置网络"><span class="toc-number">1.15.</span> <span class="toc-text">配置网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-kuboard-可视化界面"><span class="toc-number">1.16.</span> <span class="toc-text">安装 kuboard 可视化界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装-coredns"><span class="toc-number">1.17.</span> <span class="toc-text">安装 coredns</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcQ9kT-v8h4jC0espKHN3EtHBmIeDcTycpSj1Gpzg9QeX2RmxB6c&amp;usqp=CAU)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">ALAN</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="https://download.rocc.top" target="_blank" rel="noopener"><i class="fa-fw fa fa-download"></i><span> Download</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">二进制部署 kubernetes 集群</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-01-01 13:14:21"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-01-01</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-05-31 06:58:05"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-05-31</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="部署单-Master-集群"><a href="#部署单-Master-集群" class="headerlink" title="部署单 Master 集群"></a>部署单 Master 集群</h2><p><a href="https://www.notion.so/a0467bc248ea42d2a57b3bb340bef27b" target="_blank" rel="noopener">集群规划</a></p>
<h3 id="初始化服务器"><a href="#初始化服务器" class="headerlink" title="初始化服务器"></a>初始化服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.关闭防火墙</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld &amp;&amp; systemctl stop firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.关闭 selinux</span></span><br><span class="line">sed -i <span class="string">'/^SELINUX=/c SELINUX=disabled'</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.关闭 swap 分区</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">'/swap/s/^/#/g'</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.配置主机名</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname k8s-master     <span class="comment"># master 主机执行</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname k8s-node01     <span class="comment"># node01 主机执行</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname k8s-node02     <span class="comment"># node02 主机执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.配置相互解析</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">172.16.1.10 k8s-master</span><br><span class="line">172.16.1.2 k8s-node01</span><br><span class="line">172.16.1.3 k8s-node02</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.配置时间同步</span></span><br><span class="line">yum install chrony -y</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">"/^#allow/c allow 10.0.0.0/16"</span> /etc/chrony.conf  <span class="comment"># 仅 master 主机执行</span></span><br><span class="line">sed -i <span class="string">"/^#local/c local stratum 10"</span> /etc/chrony.conf   <span class="comment"># 仅 master 主机执行</span></span><br><span class="line"></span><br><span class="line">sed -i <span class="string">"/^server /s@^@#@g"</span> /etc/chrony.conf         <span class="comment"># 仅 node 主机执行</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"server 172.16.1.10 iburst"</span> &gt;&gt; /etc/chrony.conf    <span class="comment"># 仅 node 主机执行</span></span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> chronyd &amp;&amp; systemctl start chronyd</span><br><span class="line"></span><br><span class="line">chronyc sources     <span class="comment"># 检查 node 主机是否同步成功</span></span><br></pre></td></tr></table></figure>

<h3 id="部署-docker"><a href="#部署-docker" class="headerlink" title="部署 docker"></a>部署 docker</h3><p><strong>所有主机</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署 docker</span></span><br><span class="line">wget -O /etc/yum.repos.d/docker-ce.repo &lt;https://download.docker.com/linux/centos/docker-ce.repo&gt;</span><br><span class="line">sed -i <span class="string">'s+download.docker.com+mirrors.cloud.tencent.com/docker-ce+'</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">yum install docker-ce -y</span><br><span class="line">systemctl <span class="built_in">enable</span> docker &amp;&amp; systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置腾讯云 docker 镜像加速</span></span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">"registry-mirrors"</span>: [</span><br><span class="line">       <span class="string">"&lt;https://mirror.ccs.tencentyun.com&gt;"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="部署-etcd"><a href="#部署-etcd" class="headerlink" title="部署 etcd"></a>部署 etcd</h3><h3 id="颁发证书"><a href="#颁发证书" class="headerlink" title="颁发证书"></a>颁发证书</h3><p><strong>k8s-master</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 cfssl 工具</span></span><br><span class="line">wget &lt;https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&gt;</span><br><span class="line">wget &lt;https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&gt;</span><br><span class="line">wget &lt;https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64&gt;</span><br><span class="line">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssl</span><br><span class="line">mv cfssljson_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssljson</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/<span class="built_in">local</span>/bin/cfssl-certinfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成自签证书</span></span><br><span class="line">mkdir -p /ssl/etcd</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$_</span></span><br><span class="line"></span><br><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd CA"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"ShenZhen"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"ShenZhen"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"www"</span>: &#123;</span><br><span class="line">         <span class="string">"expiry"</span>: <span class="string">"87600h"</span>,</span><br><span class="line">         <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"172.16.1.10"</span>,</span><br><span class="line">    <span class="string">"172.16.1.2"</span>,</span><br><span class="line">    <span class="string">"172.16.1.3"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"ShenZhen"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"ShenZhen"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否生成了 4 个 pem 文件</span></span><br><span class="line">ls *pem | wc -l</span><br></pre></td></tr></table></figure>

<h3 id="安装-etcd"><a href="#安装-etcd" class="headerlink" title="安装 etcd"></a>安装 etcd</h3><p><strong>k8s-master</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 etcd</span></span><br><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">wget &lt;https://download.rocc.top/kubernetes/etcd/etcd-v3.3.17-linux-amd64.tar.gz&gt;</span><br><span class="line">tar xf etcd-v3.3.17-linux-amd64.tar.gz</span><br><span class="line">mkdir /opt/etcd/&#123;bin,cfg,ssl&#125; -p</span><br><span class="line">mv etcd-v3.3.17-linux-amd64/etcd* /opt/etcd/bin/</span><br><span class="line">chmod +x /opt/etcd/bin/* </span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 etcd 配置文件</span></span><br><span class="line">cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF</span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd-1"</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"&lt;https://172.16.1.10:2380&gt;"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"&lt;https://172.16.1.10:2379&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"&lt;https://172.16.1.10:2380&gt;"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"&lt;https://172.16.1.10:2379&gt;"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd-1=https://172.16.1.10:2380,etcd-2=https://172.16.1.2:2380,etcd-3=https://172.16.1.3:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># ETCD_NAME 节点名称</span></span><br><span class="line"><span class="comment"># ETCD_DATA_DIR 数据目录</span></span><br><span class="line"><span class="comment"># ETCD_LISTEN_PEER_URLS 集群通信监听地址</span></span><br><span class="line"><span class="comment"># ETCD_LISTEN_CLIENT_URLS 客户端访问监听地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ETCD_INITIAL_ADVERTISE_PEER_URLS 集群通告地址</span></span><br><span class="line"><span class="comment"># ETCD_ADVERTISE_CLIENT_URLS 客户端通告地址</span></span><br><span class="line"><span class="comment"># ETCD_INITIAL_CLUSTER 集群节点地址</span></span><br><span class="line"><span class="comment"># ETCD_INITIAL_CLUSTER_TOKEN 集群Token</span></span><br><span class="line"><span class="comment"># ETCD_INITIAL_CLUSTER_STATE 加入集群的当前状态，new是新集群，existing表示加入已有集群</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 systemd 管理</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/etcd/cfg/etcd.conf</span><br><span class="line">ExecStart=/opt/etcd/bin/etcd \\</span><br><span class="line">--name=<span class="variable">$&#123;ETCD_NAME&#125;</span> \\</span><br><span class="line">--data-dir=<span class="variable">$&#123;ETCD_DATA_DIR&#125;</span> \\</span><br><span class="line">--listen-peer-urls=<span class="variable">$&#123;ETCD_LISTEN_PEER_URLS&#125;</span> \\</span><br><span class="line">--listen-client-urls=<span class="variable">$&#123;ETCD_LISTEN_CLIENT_URLS&#125;</span>,&lt;http://127.0.0.1:2379&gt; \\</span><br><span class="line">--advertise-client-urls=<span class="variable">$&#123;ETCD_ADVERTISE_CLIENT_URLS&#125;</span> \\</span><br><span class="line">--initial-advertise-peer-urls=<span class="variable">$&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125;</span> \\</span><br><span class="line">--initial-cluster=<span class="variable">$&#123;ETCD_INITIAL_CLUSTER&#125;</span> \\</span><br><span class="line">--initial-cluster-token=<span class="variable">$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125;</span> \\</span><br><span class="line">--initial-cluster-state=new \\</span><br><span class="line">--cert-file=/opt/etcd/ssl/server.pem \\</span><br><span class="line">--key-file=/opt/etcd/ssl/server-key.pem \\</span><br><span class="line">--peer-cert-file=/opt/etcd/ssl/server.pem \\</span><br><span class="line">--peer-key-file=/opt/etcd/ssl/server-key.pem \\</span><br><span class="line">--trusted-ca-file=/opt/etcd/ssl/ca.pem \\</span><br><span class="line">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem</span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝证书</span></span><br><span class="line">cp /ssl/etcd/*pem /opt/etcd/ssl/</span><br></pre></td></tr></table></figure>

<p><strong>k8s-master</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t dsa -P <span class="string">''</span> -f ~/.ssh/id_dsa &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">ssh-copy-id k8s-node01</span><br><span class="line">ssh-copy-id k8s-node02</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 etcd 发送到 node 节点</span></span><br><span class="line">scp /usr/lib/systemd/system/etcd.service k8s-node01:/usr/lib/systemd/system/etcd.service</span><br><span class="line">scp /usr/lib/systemd/system/etcd.service k8s-node02:/usr/lib/systemd/system/etcd.service</span><br><span class="line">scp -r /opt/etcd k8s-node01:/opt</span><br><span class="line">scp -r /opt/etcd k8s-node02:/opt</span><br></pre></td></tr></table></figure>

<p><strong>k8s-node01</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 etcd 配置文件</span></span><br><span class="line">cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF</span><br><span class="line">ETCD_NAME=<span class="string">"etcd-2"</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"&lt;https://172.16.1.2:2380&gt;"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"&lt;https://172.16.1.2:2379&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"&lt;https://172.16.1.2:2380&gt;"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"&lt;https://172.16.1.2:2379&gt;"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd-1=https://172.16.1.10:2380,etcd-2=https://172.16.1.2:2380,etcd-3=https://172.16.1.3:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>k8s-node02</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 etcd 配置文件</span></span><br><span class="line">cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF</span><br><span class="line">ETCD_NAME=<span class="string">"etcd-3"</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"&lt;https://172.16.1.3:2380&gt;"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"&lt;https://172.16.1.3:2379&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"&lt;https://172.16.1.3:2380&gt;"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"&lt;https://172.16.1.3:2379&gt;"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd-1=https://172.16.1.10:2380,etcd-2=https://172.16.1.2:2380,etcd-3=https://172.16.1.3:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"etcd-cluster"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>启动 etcd</strong> （依次启动三个节点）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> etcd &amp;&amp; systemctl start etcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查各节点健康状况</span></span><br><span class="line">/opt/etcd/bin/etcdctl --ca-file=/opt/etcd/ssl/ca.pem --cert-file=/opt/etcd/ssl/server.pem --key-file=/opt/etcd/ssl/server-key.pem --endpoints=<span class="string">"&lt;https://172.16.1.10:2379&gt;,&lt;https://172.16.1.2:2379&gt;,&lt;https://172.16.1.3:2379&gt;"</span> cluster-health</span><br></pre></td></tr></table></figure>

<h3 id="部署-flannel-网络"><a href="#部署-flannel-网络" class="headerlink" title="部署 flannel 网络"></a>部署 flannel 网络</h3><p><strong>node 节点</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入预定义子网段</span></span><br><span class="line"><span class="built_in">cd</span> /opt/etcd/ssl</span><br><span class="line">/opt/etcd/bin/etcdctl \\</span><br><span class="line">--ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem \\</span><br><span class="line">--endpoints=<span class="string">"&lt;https://172.16.1.2:2379&gt;,&lt;https://172.16.1.3:2379&gt;,&lt;https://172.16.1.1:2379&gt;"</span> \\</span><br><span class="line"><span class="built_in">set</span> /coreos.com/network/config  <span class="string">'&#123; "Network": "172.17.76.0/16", "Backend": &#123;"Type": "vxlan"&#125;&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">/opt/etcd/bin/etcdctl \\</span><br><span class="line">--ca-file=ca.pem --cert-file=server.pem --key-file=server-key.pem \\</span><br><span class="line">--endpoints=<span class="string">"&lt;https://172.16.1.2:2379&gt;,&lt;https://172.16.1.3:2379&gt;,&lt;https://172.16.1.1:2379&gt;"</span> \\</span><br><span class="line">get /coreos.com/network/config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载二进制包</span></span><br><span class="line">mkdir /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125; -p</span><br><span class="line"><span class="built_in">cd</span> /opt/kubernetes/bin</span><br><span class="line"><span class="comment"># wget &lt;https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz&gt;</span></span><br><span class="line">wget &lt;https://download.rocc.top/kubernetes/flannel/flannel-v0.11.0/flanneld&gt;</span><br><span class="line">wget &lt;https://download.rocc.top/kubernetes/flannel/flannel-v0.11.0/mk-docker-opts.sh&gt;</span><br><span class="line">chmod +x /opt/kubernetes/bin/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/flanneld.conf &lt;&lt; EOF</span><br><span class="line">FLANNEL_OPTIONS=<span class="string">"\\</span></span><br><span class="line"><span class="string">--etcd-endpoints=https://172.16.1.2:2379,&lt;https://172.16.1.3:2379&gt; \\</span></span><br><span class="line"><span class="string">--etcd-cafile=/opt/etcd/ssl/ca.pem -etcd-certfile=/opt/etcd/ssl/server.pem \\</span></span><br><span class="line"><span class="string">--etcd-keyfile=/opt/etcd/ssl/server-key.pem"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 systemd 管理</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/flanneld.service &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Flanneld overlay address etcd agent</span><br><span class="line">After=network-online.target network.target</span><br><span class="line">Before=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/flanneld.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/flanneld --ip-masq <span class="variable">$FLANNEL_OPTIONS</span></span><br><span class="line">ExecStartPost=/opt/kubernetes/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 docker 启动指定子网段</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=/run/flannel/subnet.env</span><br><span class="line">ExecStart=/usr/bin/dockerd <span class="variable">$DOCKER_NETWORK_OPTIONS</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> flanneld &amp;&amp; systemctl start flanneld</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看网络</span></span><br><span class="line">ifconfig</span><br></pre></td></tr></table></figure>

<h3 id="Master-节点部署组件"><a href="#Master-节点部署组件" class="headerlink" title="Master 节点部署组件"></a>Master 节点部署组件</h3><h3 id="颁发证书-1"><a href="#颁发证书-1" class="headerlink" title="颁发证书"></a>颁发证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">mkdir /ssl/k8s</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$_</span></span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"signing"</span>: &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"profiles"</span>: &#123;</span><br><span class="line">      <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">         <span class="string">"expiry"</span>: <span class="string">"87600h"</span>,</span><br><span class="line">         <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"ShenZhen"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"ShenZhen"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 apiserver 证书</span></span><br><span class="line">cat &gt; server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"hosts"</span>: [</span><br><span class="line">      <span class="string">"3.3.3.1"</span>,</span><br><span class="line">      <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      <span class="string">"172.16.1.10"</span>,</span><br><span class="line">      <span class="string">"kubernetes"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">      <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"key"</span>: &#123;</span><br><span class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">        <span class="string">"size"</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"names"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">            <span class="string">"L"</span>: <span class="string">"ShenZhen"</span>,</span><br><span class="line">            <span class="string">"ST"</span>: <span class="string">"ShenZhen"</span>,</span><br><span class="line">            <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 kube-proxy 证书</span></span><br><span class="line">cat &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"ShenZhen"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"ShenZhen"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查是否生成了 6 个 pem 文件</span></span><br><span class="line">ls *pem | wc -l</span><br></pre></td></tr></table></figure>

<h3 id="部署-apiserver-组件"><a href="#部署-apiserver-组件" class="headerlink" title="部署 apiserver 组件"></a>部署 apiserver 组件</h3><p><strong>master</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载二进制文件</span></span><br><span class="line">mkdir /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125; -p</span><br><span class="line"> cp /ssl/k8s/*pem /opt/kubernetes/ssl/</span><br><span class="line"><span class="built_in">cd</span> /opt/kubernetes/bin</span><br><span class="line">wget &lt;https://download.rocc.top/kubernetes/v1.17.0/kubernetes-server/server/bin/kube-apiserver&gt;</span><br><span class="line">wget &lt;https://download.rocc.top/kubernetes/v1.17.0/kubernetes-server/server/bin/kube-scheduler&gt;</span><br><span class="line">wget &lt;https://download.rocc.top/kubernetes/v1.17.0/kubernetes-server/server/bin/kube-controller-manager&gt;</span><br><span class="line">wget &lt;https://download.rocc.top/kubernetes/v1.17.0/kubernetes-server/server/bin/kubectl&gt;</span><br><span class="line">chmod +x /opt/kubernetes/bin/*</span><br><span class="line">cp /opt/kubernetes/bin/* /bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 token 文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'a113e32020e784c521c13alan19lcan,kubelet-bootstrap,10001,"system:kubelet-bootstrap"'</span> &gt; /opt/kubernetes/cfg/token.csv </span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一列：随机字符串</span></span><br><span class="line"><span class="comment"># 第二列：用户名</span></span><br><span class="line"><span class="comment"># 第三列：UID</span></span><br><span class="line"><span class="comment"># 第四列：用户组</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 apiserver 配置文件</span></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">KUBE_APISERVER_OPTS=<span class="string">"--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=3 \\</span></span><br><span class="line"><span class="string">--log-dir=/opt/kubernetes/logs \\</span></span><br><span class="line"><span class="string">--etcd-servers=https://172.16.1.10:2379,&lt;https://172.16.1.2:2379&gt;,&lt;https://172.16.1.3:2379&gt; \\</span></span><br><span class="line"><span class="string">--bind-address=172.16.1.10 \\</span></span><br><span class="line"><span class="string">--secure-port=6443 \\</span></span><br><span class="line"><span class="string">--advertise-address=172.16.1.10 \\</span></span><br><span class="line"><span class="string">--allow-privileged=true \\</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=10.0.0.0/24 \\</span></span><br><span class="line"><span class="string">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,SecurityContextDeny,ServiceAccount,ResourceQuota,NodeRestriction \\</span></span><br><span class="line"><span class="string">--authorization-mode=RBAC,Node \\</span></span><br><span class="line"><span class="string">--enable-bootstrap-token-auth=true \\</span></span><br><span class="line"><span class="string">--token-auth-file=/opt/kubernetes/cfg/token.csv \\</span></span><br><span class="line"><span class="string">--service-node-port-range=30000-32767 \\</span></span><br><span class="line"><span class="string">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem  \\</span></span><br><span class="line"><span class="string">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\</span></span><br><span class="line"><span class="string">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\</span></span><br><span class="line"><span class="string">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\</span></span><br><span class="line"><span class="string">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\</span></span><br><span class="line"><span class="string">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span></span><br><span class="line"><span class="string">--etcd-cafile=/opt/etcd/ssl/ca.pem \\</span></span><br><span class="line"><span class="string">--etcd-certfile=/opt/etcd/ssl/server.pem \\</span></span><br><span class="line"><span class="string">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\</span></span><br><span class="line"><span class="string">--audit-log-maxage=30 \\</span></span><br><span class="line"><span class="string">--audit-log-maxbackup=3 \\</span></span><br><span class="line"><span class="string">--audit-log-maxsize=100 \\</span></span><br><span class="line"><span class="string">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数说明：</span></span><br><span class="line"><span class="comment"># –logtostderr                      启用日志</span></span><br><span class="line"><span class="comment"># —v                                日志等级</span></span><br><span class="line"><span class="comment"># –etcd-servers etcd                集群地址</span></span><br><span class="line"><span class="comment"># –bind-address                     监听地址</span></span><br><span class="line"><span class="comment"># –secure-port https                安全端口</span></span><br><span class="line"><span class="comment"># –advertise-address                集群通告地址</span></span><br><span class="line"><span class="comment"># –allow-privileged                 启用授权</span></span><br><span class="line"><span class="comment"># –service-cluster-ip-range         Service 虚拟 IP 地址段</span></span><br><span class="line"><span class="comment"># –enable-admission-plugins         准入控制模块</span></span><br><span class="line"><span class="comment"># –authorization-mode           认证授权，启用 RBAC 授权和节点自管理</span></span><br><span class="line"><span class="comment"># –enable-bootstrap-token-auth  启用 TLS bootstrap 功能</span></span><br><span class="line"><span class="comment"># –token-auth-file              token 文件</span></span><br><span class="line"><span class="comment"># –service-node-port-range      Service Node 类型默认分配端口范围</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 systemd 管理</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=etcd.service</span><br><span class="line">Wants=etcd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-apiserver.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-apiserver <span class="variable">$KUBE_APISERVER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kube-apiserver &amp;&amp; systemctl start kube-apiserver</span><br></pre></td></tr></table></figure>

<h3 id="部署-scheduler-组件"><a href="#部署-scheduler-组件" class="headerlink" title="部署 scheduler 组件"></a>部署 scheduler 组件</h3><p><strong>master</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 scheduler 配置文件</span></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">KUBE_SCHEDULER_OPTS=<span class="string">"--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=3 \\</span></span><br><span class="line"><span class="string">--log-dir=/opt/kubernetes/logs \\</span></span><br><span class="line"><span class="string">--master=127.0.0.1:8080 \\</span></span><br><span class="line"><span class="string">--address=127.0.0.1 \\</span></span><br><span class="line"><span class="string">--leader-elect"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># –master 连接本地 apiserver</span></span><br><span class="line"><span class="comment"># –leader-elect 当该组件启动多个时，自动选举（HA）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 systemd 管理</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-scheduler.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-scheduler <span class="variable">$KUBE_SCHEDULER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kube-scheduler &amp;&amp; systemctl start kube-scheduler</span><br></pre></td></tr></table></figure>

<h3 id="部署-controller-manager-组件"><a href="#部署-controller-manager-组件" class="headerlink" title="部署 controller-manager 组件"></a>部署 controller-manager 组件</h3><p><strong>master</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=<span class="string">"--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=5 \\</span></span><br><span class="line"><span class="string">--log-dir=/opt/kubernetes/logs \\</span></span><br><span class="line"><span class="string">--leader-elect=true \\</span></span><br><span class="line"><span class="string">--master=127.0.0.1:8080 \\</span></span><br><span class="line"><span class="string">--address=127.0.0.1 \\</span></span><br><span class="line"><span class="string">--allocate-node-cidrs=true \\</span></span><br><span class="line"><span class="string">--cluster-cidr=10.244.0.0/16 \\</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=10.0.0.0/24 \\</span></span><br><span class="line"><span class="string">--cluster-name=kubernetes \\</span></span><br><span class="line"><span class="string">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\</span></span><br><span class="line"><span class="string">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\</span></span><br><span class="line"><span class="string">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\</span></span><br><span class="line"><span class="string">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\</span></span><br><span class="line"><span class="string">--experimental-cluster-signing-duration=87600h0m0s"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 systemd 管理</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-controller-manager <span class="variable">$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查</span></span><br><span class="line">kubectl get cs</span><br></pre></td></tr></table></figure>

<h3 id="Node-节点部署组件"><a href="#Node-节点部署组件" class="headerlink" title="Node 节点部署组件"></a>Node 节点部署组件</h3><p><strong>master</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 kubelet-bootstrap 用户绑定到系统集群角色</span></span><br><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \\</span><br><span class="line">  --clusterrole=system:node-bootstrapper \\</span><br><span class="line">  --user=kubelet-bootstrap</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /opt/kubernetes/ssl/</span><br><span class="line">cat &gt; kubernetes.sh &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 kubelet bootstrapping kubeconfig </span></span><br><span class="line">BOOTSTRAP_TOKEN=a113e32020e784c521c13alan19lcan</span><br><span class="line">KUBE_APISERVER=<span class="string">"&lt;https://172.16.1.10:6443&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \\</span><br><span class="line">  --certificate-authority=./ca.pem \\</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \\</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置客户端认证参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \\</span><br><span class="line">  --token=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span> \\</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \\</span><br><span class="line">  --cluster=kubernetes \\</span><br><span class="line">  --user=kubelet-bootstrap \\</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 kube-proxy kubeconfig 文件</span></span><br><span class="line">kubectl config <span class="built_in">set</span>-cluster kubernetes \\</span><br><span class="line">  --certificate-authority=./ca.pem \\</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \\</span><br><span class="line">  --server=<span class="variable">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-credentials kube-proxy \\</span><br><span class="line">  --client-certificate=./kube-proxy.pem \\</span><br><span class="line">  --client-key=./kube-proxy-key.pem \\</span><br><span class="line">  --embed-certs=<span class="literal">true</span> \\</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config <span class="built_in">set</span>-context default \\</span><br><span class="line">  --cluster=kubernetes \\</span><br><span class="line">  --user=kube-proxy \\</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sh kubernetes.sh</span><br><span class="line">scp bootstrap.kubeconfig kube-proxy.kubeconfig k8s-node01:/opt/kubernetes/cfg/</span><br><span class="line">scp bootstrap.kubeconfig kube-proxy.kubeconfig k8s-node02:/opt/kubernetes/cfg/</span><br><span class="line">scp ca.pem kube-proxy.pem kube-proxy-key.pem k8s-node01:/opt/kubernetes/ssl/</span><br><span class="line">scp ca.pem kube-proxy.pem kube-proxy-key.pem k8s-node02:/opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure>

<h3 id="部署-kubelet-组件"><a href="#部署-kubelet-组件" class="headerlink" title="部署 kubelet 组件"></a>部署 kubelet 组件</h3><p><strong>node01</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/kubernetes/bin/</span><br><span class="line">wget &lt;https://download.rocc.top/kubernetes/v1.17.0/kubernetes-server/server/bin/kubelet&gt;</span><br><span class="line">wget &lt;https://download.rocc.top/kubernetes/v1.17.0/kubernetes-server/server/bin/kube-proxy&gt;</span><br><span class="line">chmod +x *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet.config &lt;&lt; EOF</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 172.16.1.2</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS: [<span class="string">"10.0.0.2"</span>]</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">failSwapOn: <span class="literal">false</span></span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">KUBELET_OPTS=<span class="string">"--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=3 \\</span></span><br><span class="line"><span class="string">--hostname-override=k8s-node01 \\</span></span><br><span class="line"><span class="string">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\</span></span><br><span class="line"><span class="string">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\</span></span><br><span class="line"><span class="string">--config=/opt/kubernetes/cfg/kubelet.config \\</span></span><br><span class="line"><span class="string">--cert-dir=/opt/kubernetes/ssl \\</span></span><br><span class="line"><span class="string">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># –hostname-override            在集群中显示的主机名</span></span><br><span class="line"><span class="comment"># –kubeconfig                   指定 kubeconfig 文件位置，会自动生成</span></span><br><span class="line"><span class="comment"># –bootstrap-kubeconfig         指定刚才生成的 bootstrap.kubeconfig 文件</span></span><br><span class="line"><span class="comment"># –cert-dir                     颁发证书存放位置</span></span><br><span class="line"><span class="comment"># –pod-infra-container-image    管理 Pod 网络的镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 systemd 管理</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet <span class="variable">$KUBELET_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure>

<p><strong>node02</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/kubernetes/bin/</span><br><span class="line">wget &lt;https://download.rocc.top/kubernetes/v1.17.0/kubernetes-server/server/bin/kubelet&gt;</span><br><span class="line">wget &lt;https://download.rocc.top/kubernetes/v1.17.0/kubernetes-server/server/bin/kube-proxy&gt;</span><br><span class="line">chmod +x *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet.config &lt;&lt; EOF</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 172.16.1.3</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">cgroupDriver: cgroupfs</span><br><span class="line">clusterDNS: [<span class="string">"10.0.0.2"</span>]</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">failSwapOn: <span class="literal">false</span></span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">KUBELET_OPTS=<span class="string">"--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=3 \\</span></span><br><span class="line"><span class="string">--log-dir=/opt/kubernetes/logs \\</span></span><br><span class="line"><span class="string">--network-plugin=cni \\</span></span><br><span class="line"><span class="string">--hostname-override=k8s-node02 \\</span></span><br><span class="line"><span class="string">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\</span></span><br><span class="line"><span class="string">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\</span></span><br><span class="line"><span class="string">--config=/opt/kubernetes/cfg/kubelet.config \\</span></span><br><span class="line"><span class="string">--cert-dir=/opt/kubernetes/ssl \\</span></span><br><span class="line"><span class="string">--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># –hostname-override            在集群中显示的主机名</span></span><br><span class="line"><span class="comment"># –kubeconfig                   指定 kubeconfig 文件位置，会自动生成</span></span><br><span class="line"><span class="comment"># –bootstrap-kubeconfig         指定刚才生成的 bootstrap.kubeconfig 文件</span></span><br><span class="line"><span class="comment"># –cert-dir                     颁发证书存放位置</span></span><br><span class="line"><span class="comment"># –pod-infra-container-image    管理 Pod 网络的镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 systemd 管理</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kubelet <span class="variable">$KUBELET_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure>

<p><strong>master</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl certificate approve `kubectl get csr | awk <span class="string">'NR&gt;1&#123;print $1&#125;'</span>`</span><br></pre></td></tr></table></figure>

<h3 id="部署-kube-proxy-组件"><a href="#部署-kube-proxy-组件" class="headerlink" title="部署 kube-proxy 组件"></a>部署 kube-proxy 组件</h3><p><strong>node01</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 kube-proxy 配置文件</span></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">KUBE_PROXY_OPTS=<span class="string">"--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=4 \\</span></span><br><span class="line"><span class="string">--hostname-override=172.16.1.2 \\</span></span><br><span class="line"><span class="string">--cluster-cidr=10.0.0.0/24 \\</span></span><br><span class="line"><span class="string">--kubeconfig=/opt/kubernetes/cfg/kube-proxy.kubeconfig"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 systemd 管理 Kube-proxy 组件</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy <span class="variable">$KUBE_PROXY_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kube-proxy &amp;&amp; systemctl start kube-proxy</span><br></pre></td></tr></table></figure>

<p><strong>node02</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 kube-proxy 配置文件</span></span><br><span class="line">cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">KUBE_PROXY_OPTS=<span class="string">"--logtostderr=true \\</span></span><br><span class="line"><span class="string">--v=4 \\</span></span><br><span class="line"><span class="string">--hostname-override=172.16.1.3 \\</span></span><br><span class="line"><span class="string">--cluster-cidr=10.0.0.0/24 \\</span></span><br><span class="line"><span class="string">--kubeconfig=/opt/kubernetes/cfg/kube-proxy.kubeconfig"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 systemd 管理 Kube-proxy 组件</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/opt/kubernetes/cfg/kube-proxy.conf</span><br><span class="line">ExecStart=/opt/kubernetes/bin/kube-proxy <span class="variable">$KUBE_PROXY_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kube-proxy &amp;&amp; systemctl start kube-proxy</span><br></pre></td></tr></table></figure>

<h3 id="配置网络"><a href="#配置网络" class="headerlink" title="配置网络"></a>配置网络</h3><p><strong>node</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget &lt;https://download.rocc.top/kubernetes/cni/cni-plugins-linux-amd64-v0.8.5.tgz&gt;</span><br><span class="line">mkdir -p /opt/cni/bin /etc/cni/net.d/</span><br><span class="line">tar xf cni-plugins-linux-amd64-v0.8.5.tgz -C /opt/cni/bin/</span><br></pre></td></tr></table></figure>

<p><strong><em>master\</em></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f &lt;https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml&gt;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image&#x3D;nginx --replicas&#x3D;3</span><br><span class="line">kubectl expose deployment nginx --port&#x3D;80 --type&#x3D;NodePort</span><br><span class="line">kubectl get svc</span><br></pre></td></tr></table></figure>

<h3 id="安装-kuboard-可视化界面"><a href="#安装-kuboard-可视化界面" class="headerlink" title="安装 kuboard 可视化界面"></a>安装 kuboard 可视化界面</h3><p><strong>master</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f &lt;https://kuboard.cn/install-script/kuboard.yaml&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看运行状态</span></span><br><span class="line">kubectl get pods -l k8s.eip.work/name=kuboard -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 token</span></span><br><span class="line">kubectl -n kube-system get secret $(kubectl -n kube-system get secret | grep kuboard-user | awk <span class="string">'&#123;print $1&#125;'</span>) -o go-template=<span class="string">'&#123;&#123;.data.token&#125;&#125;'</span> | base64 -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看暴露的端口</span></span><br><span class="line">kubectl get svc -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器访问任意 node 节点的 IP:暴露的端口</span></span><br></pre></td></tr></table></figure>

<h3 id="安装-coredns"><a href="#安装-coredns" class="headerlink" title="安装 coredns"></a>安装 coredns</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> &lt;https://github.com/coredns/deployment.git&gt;</span><br><span class="line"><span class="built_in">cd</span> deployment/kubernetes</span><br><span class="line">yum install jq -y</span><br><span class="line">./deploy.sh -i 3.3.3.254 &gt; coredns.yaml</span><br><span class="line">kubectl apply -f coredns.yaml</span><br></pre></td></tr></table></figure>
</div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kubernetes/">kubernetes</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/05/01/Kubeadm%20%E9%83%A8%E7%BD%B2%20kubernetes%20v1.18.2%20%E9%9B%86%E7%BE%A4/"><img class="prev_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Kubeadm 部署 kubernetes v1.18.2 集群（腾讯云版）</div></div></a></div><div class="next-post pull_right"><a href="/2019/10/01/Docker%20%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/"><img class="next_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Docker 基础入门</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/05/01/Kubeadm 部署 kubernetes v1.18.2 集群/" title="Kubeadm 部署 kubernetes v1.18.2 集群（腾讯云版）"><img class="relatedPosts_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-01</div><div class="relatedPosts_title">Kubeadm 部署 kubernetes v1.18.2 集群（腾讯云版）</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By ALAN</div><div class="footer_custom_text">yuiya@yahoo.com</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode far fa-sun" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script></body></html>