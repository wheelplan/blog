<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Nginx 基础入门 | ALAN</title><meta name="description" content="NginxNginx 介绍1.Nginx 是什么 ？Nginx 是一款轻量级 Web 服务器 &#x2F; 反向代理服务器及电子邮件（IMAP&#x2F;POP3）代理服务器，在 BSD-like 协议下发行。其特点是占有内存少，并发能力强，事实上 nginx 的并发能力在同类型的网页服务器中表现较好，中国大陆使用 nginx 网站用户有：百度、京东、新浪、网易、腾讯、淘宝 等。 Nginx 是一个开源且高性能、可靠"><meta name="keywords" content="nginx 部署 反向代理 负载均衡 性能优化 yum 仓库"><meta name="author" content="ALAN"><meta name="copyright" content="ALAN"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Nginx 基础入门"><meta name="twitter:description" content="NginxNginx 介绍1.Nginx 是什么 ？Nginx 是一款轻量级 Web 服务器 &#x2F; 反向代理服务器及电子邮件（IMAP&#x2F;POP3）代理服务器，在 BSD-like 协议下发行。其特点是占有内存少，并发能力强，事实上 nginx 的并发能力在同类型的网页服务器中表现较好，中国大陆使用 nginx 网站用户有：百度、京东、新浪、网易、腾讯、淘宝 等。 Nginx 是一个开源且高性能、可靠"><meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Nginx 基础入门"><meta property="og:url" content="https://rocc.top/2017/03/01/Nginx%20%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/"><meta property="og:site_name" content="ALAN"><meta property="og:description" content="NginxNginx 介绍1.Nginx 是什么 ？Nginx 是一款轻量级 Web 服务器 &#x2F; 反向代理服务器及电子邮件（IMAP&#x2F;POP3）代理服务器，在 BSD-like 协议下发行。其特点是占有内存少，并发能力强，事实上 nginx 的并发能力在同类型的网页服务器中表现较好，中国大陆使用 nginx 网站用户有：百度、京东、新浪、网易、腾讯、淘宝 等。 Nginx 是一个开源且高性能、可靠"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2017-03-01T15:56:21.000Z"><meta property="article:modified_time" content="2020-06-09T13:11:26.000Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://rocc.top/2017/03/01/Nginx%20%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/"><link rel="prev" title="Zabbix 监控" href="https://rocc.top/2018/02/13/Zabbix%20%E7%9B%91%E6%8E%A7/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://rocc.top/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"Press","message_next":"to bookmark this page"},"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: true,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/cc-001.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">9</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="https://download.rocc.top" target="_blank" rel="noopener"><i class="fa-fw fa fa-download"></i><span> Download</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx"><span class="toc-number">1.</span> <span class="toc-text">Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-介绍"><span class="toc-number">1.0.1.</span> <span class="toc-text">Nginx 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Nginx-是什么-？"><span class="toc-number">1.0.1.0.1.</span> <span class="toc-text">1.Nginx 是什么 ？</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-我们为什么选择-Nginx-服务-？"><span class="toc-number">1.0.1.0.2.</span> <span class="toc-text">2.我们为什么选择 Nginx 服务 ？</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-Nginx-的重要特性"><span class="toc-number">1.0.1.0.3.</span> <span class="toc-text">3.Nginx 的重要特性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-安装部署"><span class="toc-number">1.0.2.</span> <span class="toc-text">Nginx 安装部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#⦁-编译安装方法"><span class="toc-number">1.0.2.1.</span> <span class="toc-text">⦁     编译安装方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#⦁-YUM-安装方法"><span class="toc-number">1.0.2.2.</span> <span class="toc-text">⦁     YUM 安装方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#⦁-Nginx-启动方式"><span class="toc-number">1.0.2.3.</span> <span class="toc-text">⦁     Nginx 启动方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-重要配置文件说明"><span class="toc-number">1.0.3.</span> <span class="toc-text">Nginx 重要配置文件说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-虚拟主机配置实践"><span class="toc-number">1.0.4.</span> <span class="toc-text">Nginx 虚拟主机配置实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#⦁-基于域名的虚拟主机"><span class="toc-number">1.0.4.1.</span> <span class="toc-text">⦁    基于域名的虚拟主机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#⦁-基于端口的虚拟主机"><span class="toc-number">1.0.4.2.</span> <span class="toc-text">⦁     基于端口的虚拟主机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#⦁-基于-IP-的虚拟主机"><span class="toc-number">1.0.4.3.</span> <span class="toc-text">⦁     基于 IP 的虚拟主机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#⦁-Nginx-虚拟主机配置优化"><span class="toc-number">1.0.4.4.</span> <span class="toc-text">⦁     Nginx 虚拟主机配置优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#⦁-Nginx-状态模块"><span class="toc-number">1.0.5.</span> <span class="toc-text">⦁     Nginx 状态模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-日志"><span class="toc-number">1.0.6.</span> <span class="toc-text">Nginx 日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-防坑指南"><span class="toc-number">1.0.7.</span> <span class="toc-text">Nginx 防坑指南</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#常用模块"><span class="toc-number">2.</span> <span class="toc-text">常用模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Nginx-目录索引"><span class="toc-number">2.1.</span> <span class="toc-text">1. Nginx 目录索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#autoindex-语法"><span class="toc-number">2.1.1.</span> <span class="toc-text">autoindex 语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#autoindex-常用参数"><span class="toc-number">2.1.2.</span> <span class="toc-text">autoindex 常用参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置实例"><span class="toc-number">2.1.3.</span> <span class="toc-text">配置实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Nginx-状态监控"><span class="toc-number">2.2.</span> <span class="toc-text">2. Nginx 状态监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#stub-status-语法（ngx-http-stub-status-module）"><span class="toc-number">2.2.1.</span> <span class="toc-text">stub_status 语法（ngx_http_stub_status_module）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#状态字段释义"><span class="toc-number">2.2.2.</span> <span class="toc-text">状态字段释义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置实例-1"><span class="toc-number">2.2.3.</span> <span class="toc-text">配置实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Nginx-访问控制"><span class="toc-number">2.3.</span> <span class="toc-text">3. Nginx 访问控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基于-IP-的访问控制-ngx-http-access-module"><span class="toc-number">2.3.1.</span> <span class="toc-text">基于 IP 的访问控制 ngx_http_access_module</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基于用户登录认证的访问控制-ngx-http-auth-basic-module"><span class="toc-number">2.3.2.</span> <span class="toc-text">基于用户登录认证的访问控制 ngx_http_auth_basic_module</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-请求限制"><span class="toc-number">2.4.</span> <span class="toc-text">Nginx 请求限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-Location"><span class="toc-number">2.5.</span> <span class="toc-text">Nginx Location</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置实例测试-Location-优先级"><span class="toc-number">2.5.1.</span> <span class="toc-text">配置实例测试 Location 优先级</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#反向代理"><span class="toc-number">3.</span> <span class="toc-text">反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#代理介绍"><span class="toc-number">3.1.</span> <span class="toc-text">代理介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-反向代理参数解释"><span class="toc-number">3.2.</span> <span class="toc-text">Nginx 反向代理参数解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#优化代理配置文件"><span class="toc-number">3.3.</span> <span class="toc-text">优化代理配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-反向代理实践"><span class="toc-number">3.4.</span> <span class="toc-text">Nginx 反向代理实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#web01-配置"><span class="toc-number">3.4.1.</span> <span class="toc-text">web01 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lb01-配置"><span class="toc-number">3.4.2.</span> <span class="toc-text">lb01 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试访问"><span class="toc-number">3.4.3.</span> <span class="toc-text">测试访问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#负载均衡"><span class="toc-number">4.</span> <span class="toc-text">负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么需要负载均衡"><span class="toc-number">4.1.</span> <span class="toc-text">为什么需要负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#负载均衡和反向代理的关系"><span class="toc-number">4.2.</span> <span class="toc-text">负载均衡和反向代理的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#负载均衡配置场景"><span class="toc-number">4.3.</span> <span class="toc-text">负载均衡配置场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#四层负载均衡"><span class="toc-number">4.3.1.</span> <span class="toc-text">四层负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#七层负载均衡"><span class="toc-number">4.3.2.</span> <span class="toc-text">七层负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四层与七层负载均衡对比"><span class="toc-number">4.3.3.</span> <span class="toc-text">四层与七层负载均衡对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-负载均衡实践"><span class="toc-number">4.4.</span> <span class="toc-text">Nginx 负载均衡实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目需求"><span class="toc-number">4.4.1.</span> <span class="toc-text">项目需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主机目录规划"><span class="toc-number">4.4.2.</span> <span class="toc-text">主机目录规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-配置文件"><span class="toc-number">4.4.3.</span> <span class="toc-text">Nginx 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成测试页面"><span class="toc-number">4.4.4.</span> <span class="toc-text">生成测试页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-服务器测试访问"><span class="toc-number">4.4.5.</span> <span class="toc-text">Web 服务器测试访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lb-服务器-nginx-配置"><span class="toc-number">4.4.6.</span> <span class="toc-text">lb 服务器 nginx 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#访问测试"><span class="toc-number">4.4.7.</span> <span class="toc-text">访问测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#负载均衡调度算法实验"><span class="toc-number">4.5.</span> <span class="toc-text">负载均衡调度算法实验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Weight-实验"><span class="toc-number">4.5.1.</span> <span class="toc-text">Weight 实验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ip-hash-实验"><span class="toc-number">4.5.2.</span> <span class="toc-text">ip_hash 实验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#url-hash-实验"><span class="toc-number">4.5.3.</span> <span class="toc-text">url_hash 实验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试命令"><span class="toc-number">4.5.4.</span> <span class="toc-text">测试命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#负载均衡配置参数实验"><span class="toc-number">4.6.</span> <span class="toc-text">负载均衡配置参数实验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Down-参数"><span class="toc-number">4.6.1.</span> <span class="toc-text">Down 参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Backup-参数"><span class="toc-number">4.6.2.</span> <span class="toc-text">Backup 参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#根据条件转发实验"><span class="toc-number">4.7.</span> <span class="toc-text">根据条件转发实验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#根据客户端类型转发"><span class="toc-number">4.7.1.</span> <span class="toc-text">根据客户端类型转发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#根据文件类型转发"><span class="toc-number">4.7.2.</span> <span class="toc-text">根据文件类型转发</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#性能优化"><span class="toc-number">5.</span> <span class="toc-text">性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#影响性能的主要因素"><span class="toc-number">5.1.</span> <span class="toc-text">影响性能的主要因素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#系统性能优化"><span class="toc-number">5.2.</span> <span class="toc-text">系统性能优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-性能优化"><span class="toc-number">5.3.</span> <span class="toc-text">Nginx 性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#优化-Nginx-进程数量"><span class="toc-number">5.3.1.</span> <span class="toc-text">优化 Nginx 进程数量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#将不同的进程绑定到不同的CPU"><span class="toc-number">5.3.2.</span> <span class="toc-text">将不同的进程绑定到不同的CPU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-事件处理模型优化"><span class="toc-number">5.3.3.</span> <span class="toc-text">Nginx 事件处理模型优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#单个进程允许的客户端最大连接数"><span class="toc-number">5.3.4.</span> <span class="toc-text">单个进程允许的客户端最大连接数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置获取更多连接数"><span class="toc-number">5.3.5.</span> <span class="toc-text">配置获取更多连接数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-worker-进程的最大打开文件数"><span class="toc-number">5.3.6.</span> <span class="toc-text">配置 worker 进程的最大打开文件数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化域名的散列表大小"><span class="toc-number">5.3.7.</span> <span class="toc-text">优化域名的散列表大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP-优化"><span class="toc-number">5.3.8.</span> <span class="toc-text">TCP 优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#优化连接参数"><span class="toc-number">5.3.9.</span> <span class="toc-text">优化连接参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置压缩优化"><span class="toc-number">5.3.10.</span> <span class="toc-text">配置压缩优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#静态资源优化"><span class="toc-number">5.3.11.</span> <span class="toc-text">静态资源优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#制作内部网络-yum-仓库"><span class="toc-number">6.</span> <span class="toc-text">制作内部网络 yum 仓库</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://pic1.zhimg.com/v2-e68d524210343613129267bd2cb75a0d_1200x500.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">ALAN</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="https://download.rocc.top" target="_blank" rel="noopener"><i class="fa-fw fa fa-download"></i><span> Download</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Nginx 基础入门</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2017-03-01 23:56:21"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2017-03-01</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-06-09 21:11:26"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-06-09</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h3 id="Nginx-介绍"><a href="#Nginx-介绍" class="headerlink" title="Nginx 介绍"></a>Nginx 介绍</h3><h5 id="1-Nginx-是什么-？"><a href="#1-Nginx-是什么-？" class="headerlink" title="1.Nginx 是什么 ？"></a>1.Nginx 是什么 ？</h5><p>Nginx 是一款轻量级 Web 服务器 / 反向代理服务器及电子邮件（IMAP/POP3）代理服务器，在 BSD-like 协议下发行。其特点是占有内存少，<a href="https://baike.baidu.com/item/并发/11024806" target="_blank" rel="noopener">并发</a>能力强，事实上 nginx 的并发能力在同类型的网页服务器中表现较好，中国大陆使用 nginx 网站用户有：百度、<a href="https://baike.baidu.com/item/京东/210931" target="_blank" rel="noopener">京东</a>、<a href="https://baike.baidu.com/item/新浪/125692" target="_blank" rel="noopener">新浪</a>、<a href="https://baike.baidu.com/item/网易/185754" target="_blank" rel="noopener">网易</a>、<a href="https://baike.baidu.com/item/腾讯/112204" target="_blank" rel="noopener">腾讯</a>、<a href="https://baike.baidu.com/item/淘宝/145661" target="_blank" rel="noopener">淘宝</a> 等。</p>
<p>Nginx 是一个开源且高性能、可靠的 Http Web 服务、代理服务。</p>
<p>开源: 直接获取源代码</p>
<p>高性能: 支持海量并发</p>
<p>可靠: 服务稳定</p>
<h5 id="2-我们为什么选择-Nginx-服务-？"><a href="#2-我们为什么选择-Nginx-服务-？" class="headerlink" title="2.我们为什么选择 Nginx 服务 ？"></a>2.我们为什么选择 Nginx 服务 ？</h5><p>Nginx 非常轻量</p>
<p>功能模块少 (源代码仅保留 http 与核心模块代码,其余不够核心代码会作为插件来安装)</p>
<p>代码模块化 (易读，便于二次开发，对于开发人员非常友好)</p>
<p>互联网公司都选择 Nginx</p>
<p>1.Nginx 技术成熟，具备的功能是企业最常使用而且最需要的</p>
<p>2.适合当前主流架构趋势, 微服务、云架构、中间层</p>
<p>3.统一技术栈, 降低维护成本, 降低技术更新成本。</p>
<h5 id="3-Nginx-的重要特性"><a href="#3-Nginx-的重要特性" class="headerlink" title="3.Nginx 的重要特性"></a>3.Nginx 的重要特性</h5><p>Nginx 采用 Epool 网络模型， Apache 采用 Select 模型</p>
<p>Select：当用户发起一次请求， select 模型就会进行一次遍历扫描，从而导致性能低下。</p>
<p>Epool：当用户发起请求， epool 模型会直接进行处理，效率高效，并无连接限制</p>
<br>

<h3 id="Nginx-安装部署"><a href="#Nginx-安装部署" class="headerlink" title="Nginx 安装部署"></a>Nginx 安装部署</h3><p>1.源码编译(1.版本随意 2.安装复杂 3.升级繁琐)</p>
<p>2.epel 仓库(1.版本较低 2.安装简单 3.配置不易读)</p>
<p>3.官方仓库(1.版本较新 2.安装简单 3.配置易读，推荐)</p>
<p>下面分别介绍编译安装和 yum 安装方法</p>
<h4 id="⦁-编译安装方法"><a href="#⦁-编译安装方法" class="headerlink" title="⦁     编译安装方法"></a>⦁     编译安装方法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建www用户</span></span><br><span class="line">groupadd www -g 666</span><br><span class="line">useradd www -s /sbin/nologin -M -u 666 -g 666</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖包</span></span><br><span class="line">yum install openssl-devel pcre-devel -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载解压软件包</span></span><br><span class="line">mkdir /data/soft -p</span><br><span class="line"><span class="built_in">cd</span> /data/soft/</span><br><span class="line">wget http://nginx.org/download/nginx-1.16.0.tar.gz</span><br><span class="line">tar zxvf nginx-1.16.0.tar.gz </span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置编译参数</span></span><br><span class="line"><span class="built_in">cd</span> /data/soft/nginx-1.16.0/</span><br><span class="line">./configure --<span class="built_in">help</span></span><br><span class="line">./configure --user=www --group=www --prefix=/opt/nginx-1.16.0/ --with-http_stub_status_module --with-http_ssl_module --with-pcre</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译安装</span></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建软链接</span></span><br><span class="line">ln -s /opt/nginx-1.16.0/ /opt/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查语法</span></span><br><span class="line">/opt/nginx/sbin/nginx -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动nginx</span></span><br><span class="line">/opt/nginx/sbin/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查测试</span></span><br><span class="line">netstat -lntup | grep nginx</span><br><span class="line">curl 10.0.1.7</span><br></pre></td></tr></table></figure>

<h4 id="⦁-YUM-安装方法"><a href="#⦁-YUM-安装方法" class="headerlink" title="⦁     YUM 安装方法"></a>⦁     YUM 安装方法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖包</span></span><br><span class="line">yum install openssl-devel pcre-devel -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置官方 yum 源</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 nginx 服务</span></span><br><span class="line">yum install nginx -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务并配置开机自启动</span></span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试访问 </span></span><br><span class="line">curl 10.0.1.7</span><br></pre></td></tr></table></figure>

<br>

<h4 id="⦁-Nginx-启动方式"><a href="#⦁-Nginx-启动方式" class="headerlink" title="⦁     Nginx 启动方式"></a>⦁     Nginx 启动方式</h4><p>编译安装启动管理方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">nginx</span><br><span class="line">nginx -s reload</span><br><span class="line">nginx -s stop</span><br></pre></td></tr></table></figure>

<p>yum 安装启动管理方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl reload nginx</span><br><span class="line">systemctl restart nginx</span><br><span class="line">systemctl stop  nginx</span><br></pre></td></tr></table></figure>

<h3 id="Nginx-重要配置文件说明"><a href="#Nginx-重要配置文件说明" class="headerlink" title="Nginx 重要配置文件说明"></a>Nginx 重要配置文件说明</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看配置文件</span></span><br><span class="line">rpm -ql nginx                      </span><br><span class="line">/etc/logrotate.d/nginx                     <span class="comment"># nginx 日志切割的配置文件</span></span><br><span class="line">/etc/nginx/nginx.conf                      <span class="comment"># nginx 主配置文件 </span></span><br><span class="line">/etc/nginx/conf.d                          <span class="comment"># 子配置文件</span></span><br><span class="line">/etc/nginx/conf.d/default.conf             <span class="comment"># 默认展示的页面一样 </span></span><br><span class="line">/etc/nginx/mime.types                      <span class="comment"># 媒体类型 （http 协议中的文件类型）</span></span><br><span class="line">/etc/sysconfig/nginx                       <span class="comment"># systemctl 管理 nginx 的使用的文件</span></span><br><span class="line">/usr/lib/systemd/system/nginx.service      <span class="comment"># systemctl 管理 nginx（开 关 重启 reload)配置文件       </span></span><br><span class="line">/usr/sbin/nginx                            <span class="comment"># nginx命令</span></span><br><span class="line">/usr/share/nginx/html                      <span class="comment"># 站点目录 网站的根目录 </span></span><br><span class="line">/var/<span class="built_in">log</span>/nginx                             <span class="comment"># nginx 日志 access.log 访问日志</span></span><br></pre></td></tr></table></figure>

<p>⦁     查看已经编译的模块 <code>nginx -V</code></p>
<p>⦁     配置文件注解</p>
<p>Nginx 主配置文件 /etc/nginx/nginx.conf 是一个纯文本类型的文件，整个配置文件是以区块的形式组织的。一般，每个区块以一对大括号{}来表示开始与结束。</p>
<p>Nginx 主配置文件整体分为三块，分别是 </p>
<p>CoreModule(核心模块)</p>
<p>EventModule(事件驱动模块)</p>
<p>HttpCoreModule(http 内核模块)</p>
<p>⦁     第一部分：配置文件主区域配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user nginx;                <span class="comment"># 定义运行 nginx 进程的用户</span></span><br><span class="line">worker_processes  1;       <span class="comment"># Nginx 运行的 work 进程数量(建议与 CPU 数量一致或 auto)</span></span><br><span class="line"></span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;  <span class="comment"># nginx 错误日志</span></span><br><span class="line">pid        /var/run/nginx.pid;             <span class="comment"># nginx 运行 pid</span></span><br></pre></td></tr></table></figure>

<p>⦁     第二部分：配置文件事件区域</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;  <span class="comment"># 每个 worker 进程支持的最大连接数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>⦁     第三部分：配置 http 区域</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;          <span class="comment"># Nginx 支持的媒体类型库文件</span></span><br><span class="line">    default_type  application/octet-stream;       <span class="comment"># 默认的媒体类型 </span></span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line">    </span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;    <span class="comment"># 访问日志保存路径</span></span><br><span class="line">    </span><br><span class="line">    sendfile        on;                             <span class="comment"># 开启高效传输模式</span></span><br><span class="line">    <span class="comment">#tcp_nopush     on;                       </span></span><br><span class="line">    keepalive_timeout  65;                          <span class="comment"># 连接超时时间</span></span><br><span class="line">    <span class="comment">#gzip  on;                                      # 开启压缩</span></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;               <span class="comment"># 包含子配置文件</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>⦁     第四部分：子配置文件内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">egrep -v <span class="string">"# | ^$"</span> /etc/nginx/conf.d/default.conf     </span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;             <span class="comment"># 指定监听端口</span></span><br><span class="line">    server_name  localhost;      <span class="comment"># 指定监听的域名</span></span><br><span class="line">    location / &#123;              </span><br><span class="line">        root   /usr/share/nginx/html;     <span class="comment"># 定义站点的目录</span></span><br><span class="line">        index  index.html index.htm;      <span class="comment"># 定义首页文件</span></span><br><span class="line">    &#125;</span><br><span class="line">    error_page   500 502 503 504  /50x.html;   <span class="comment"># 错误页面信息</span></span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>http server location 扩展了解项</p>
<p>http{} 层下允许有多个 Server{} 层，一个 Server{} 层下又允许有多个 Location</p>
<p>http{} 标签主要用来解决用户的请求与响应。</p>
<p>server{} 标签主要用来响应具体的某一个网站。</p>
<p>location{} 标签主要用于匹配网站具体 URL 路径。</p>
<h3 id="Nginx-虚拟主机配置实践"><a href="#Nginx-虚拟主机配置实践" class="headerlink" title="Nginx 虚拟主机配置实践"></a>Nginx 虚拟主机配置实践</h3><h4 id="⦁-基于域名的虚拟主机"><a href="#⦁-基于域名的虚拟主机" class="headerlink" title="⦁    基于域名的虚拟主机"></a>⦁    基于域名的虚拟主机</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/nginx.conf  &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line">    </span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line">    </span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line">    </span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#include /etc/nginx/conf.d/*.conf;</span></span><br><span class="line">    server   &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  www.rocc.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /usr/share/nginx/html/www;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server   &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  blog.rocc.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /usr/share/nginx/html/blog;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="⦁-基于端口的虚拟主机"><a href="#⦁-基于端口的虚拟主机" class="headerlink" title="⦁     基于端口的虚拟主机"></a>⦁     基于端口的虚拟主机</h4><p>端口号优先级比域名要高</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/nginx.conf &lt;&lt; <span class="string">'EOF'</span> </span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line">    </span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line">    </span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line">    </span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#include /etc/nginx/conf.d/*.conf;</span></span><br><span class="line">    server   &#123;</span><br><span class="line">        listen       81;</span><br><span class="line">        server_name  www.rocc.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /usr/share/nginx/html/www;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server   &#123;</span><br><span class="line">        listen       82;</span><br><span class="line">        server_name  blog.rocc.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /usr/share/nginx/html/blog;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="⦁-基于-IP-的虚拟主机"><a href="#⦁-基于-IP-的虚拟主机" class="headerlink" title="⦁     基于 IP 的虚拟主机"></a>⦁     基于 IP 的虚拟主机</h4><p>添加第二 IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr add 10.0.0.11/24 dev eth0</span><br></pre></td></tr></table></figure>

<p>配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/nginx.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line">    </span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line">    </span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line">    </span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#include /etc/nginx/conf.d/*.conf;</span></span><br><span class="line">    server   &#123;</span><br><span class="line">        listen       10.0.1.7:81;</span><br><span class="line">        server_name  www.rocc.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /usr/share/nginx/html/www;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server   &#123;</span><br><span class="line">        listen       10.0.1.11:82;</span><br><span class="line">        server_name  blog.rocc.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /usr/share/nginx/html/blog;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="⦁-Nginx-虚拟主机配置优化"><a href="#⦁-Nginx-虚拟主机配置优化" class="headerlink" title="⦁     Nginx 虚拟主机配置优化"></a>⦁     Nginx 虚拟主机配置优化</h4><p>所有配置都写入一个配置文件维护起来比较麻烦，如果修改错了，影响所有的页面，所以我们应该拆分 nginx 的配置文件为各个子配置</p>
<p>⦁     Nginx主配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/nginx.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line">    </span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line">    </span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line">    </span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line">    </span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<p>⦁     子配置文件 www</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/conf.d/01-www.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">server   &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  www.rocc.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html/www;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<p>⦁     子配置文件 blog</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/conf.d/02-blog.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">server   &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  blog.rocc.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html/blog;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>⦁     创建代码目录及首页</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/share/nginx/html/&#123;www,blog&#125;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"www"</span> &gt; /usr/share/nginx/html/www/index.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"blog"</span> &gt; /usr/share/nginx/html/blog/index.html</span><br></pre></td></tr></table></figure>

<p>⦁     检查语法重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line"><span class="comment"># nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span></span><br><span class="line"><span class="comment"># nginx: configuration file /etc/nginx/nginx.conf test is successful</span></span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p>⦁     访问测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tail -1 /etc/hosts </span><br><span class="line"><span class="comment"># 10.0.1.7 www.rocc.com blog.rocc.com</span></span><br><span class="line">curl www.rocc.com</span><br><span class="line"><span class="comment"># www</span></span><br><span class="line">curl blog.rocc.com</span><br><span class="line"><span class="comment"># blog</span></span><br></pre></td></tr></table></figure>

<h3 id="⦁-Nginx-状态模块"><a href="#⦁-Nginx-状态模块" class="headerlink" title="⦁     Nginx 状态模块"></a>⦁     Nginx 状态模块</h3><p>nginx状态模块：  –with-http_stub_status_module</p>
<p>⦁    状态模块配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; status.conf &lt;&lt; EOF</span><br><span class="line">server &#123;</span><br><span class="line">   listen 80;</span><br><span class="line">   server_name  status.rocc.com;</span><br><span class="line">   stub_status on;</span><br><span class="line">   access_log off;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">tail -1 /etc/hosts   </span><br><span class="line"><span class="comment"># 10.0.1.7 www.rocc.com blog.rocc.com status.rocc.com</span></span><br><span class="line"></span><br><span class="line">nginx -t</span><br><span class="line"><span class="comment"># nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span></span><br><span class="line"><span class="comment"># nginx: configuration file /etc/nginx/nginx.conf test is successful</span></span><br><span class="line"></span><br><span class="line">systemctl restart nginx</span><br><span class="line">curl status.rocc.com </span><br><span class="line"><span class="comment"># Active connections: 1 </span></span><br><span class="line"><span class="comment"># server accepts handled requests</span></span><br><span class="line"><span class="comment">#  1 1 1 </span></span><br><span class="line"><span class="comment"># Reading: 0 Writing: 1 Waiting: 0</span></span><br></pre></td></tr></table></figure>

<h3 id="Nginx-日志"><a href="#Nginx-日志" class="headerlink" title="Nginx 日志"></a>Nginx 日志</h3><p>⦁     日志字段解释</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$remote_addr</span> <span class="comment"># 记录客户端 IP 地址</span></span><br><span class="line"><span class="variable">$remote_user</span> <span class="comment"># 记录客户端用户名</span></span><br><span class="line"><span class="variable">$time_local</span> <span class="comment"># 记录通用的本地时间</span></span><br><span class="line"><span class="variable">$time_iso8601</span> <span class="comment"># 记录 ISO8601 标准格式下的本地时间</span></span><br><span class="line"><span class="variable">$request</span> <span class="comment"># 记录请求的方法以及请求的 http 协议</span></span><br><span class="line"><span class="variable">$status</span> <span class="comment"># 记录请求状态码(用于定位错误信息)</span></span><br><span class="line"><span class="variable">$body_bytes_sent</span> <span class="comment"># 发送给客户端的资源字节数，不包括响应头的大小</span></span><br><span class="line"><span class="variable">$bytes_sent</span> <span class="comment"># 发送给客户端的总字节数</span></span><br><span class="line"><span class="variable">$msec</span> <span class="comment"># 日志写入时间。单位为秒，精度是毫秒。</span></span><br><span class="line"><span class="variable">$http_referer</span> <span class="comment"># 记录从哪个页面链接访问过来的</span></span><br><span class="line"><span class="variable">$http_user_agent</span> <span class="comment"># 记录客户端浏览器相关信息</span></span><br><span class="line"><span class="variable">$http_x_forwarded_for</span> <span class="comment">#记录客户端 IP 地址</span></span><br><span class="line"><span class="variable">$request_length</span> <span class="comment"># 请求的长度（包括请求行， 请求头和请求正文）。</span></span><br><span class="line"><span class="variable">$request_time</span> <span class="comment"># 请求花费的时间，单位为秒，精度毫秒</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注:如果 Nginx 位于负载均衡器， nginx 反向代理之后， web 服务器无法直接获取到客 户端真实的 IP 地址。</span></span><br><span class="line"><span class="comment"># $remote_addr 获取的是反向代理的 IP 地址。 反向代理服务器在转发请求的 http 头信息中，</span></span><br><span class="line"><span class="comment"># 增加 X-Forwarded-For 信息，用来记录客户端 IP 地址和客户端请求的服务器地址。</span></span><br></pre></td></tr></table></figure>



<h3 id="Nginx-防坑指南"><a href="#Nginx-防坑指南" class="headerlink" title="Nginx 防坑指南"></a>Nginx 防坑指南</h3><p>1.端口优先级高于域名</p>
<p>2.ip + 端口的优先级是最高的</p>
<p>3.所有域名都匹配不上的时候,默认转发到根据 ASCII 码排序优先的配置文件</p>
<p>4.可以添加参数指定默认匹配的页面,这样就无需修改文件名了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server;</span><br><span class="line">    server_name  www.my.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /code/www;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h1><h2 id="1-Nginx-目录索引"><a href="#1-Nginx-目录索引" class="headerlink" title="1. Nginx 目录索引"></a>1. Nginx 目录索引</h2><h3 id="autoindex-语法"><a href="#autoindex-语法" class="headerlink" title="autoindex 语法"></a>autoindex 语法</h3><p>语法 Syntax ：autoindex on | off;</p>
<p>默认值 Default ：autoindex off;</p>
<p>环境 Context ：http, server, location</p>
<h3 id="autoindex-常用参数"><a href="#autoindex-常用参数" class="headerlink" title="autoindex 常用参数"></a>autoindex 常用参数</h3><p><strong>autoindex_exact_size off;</strong></p>
<p>默认为 on， 显示出文件的确切大小，单位是 bytes。</p>
<p>修改为 off，显示出文件的大概大小，单位是 kB 或者 MB 或者 GB。</p>
<p><strong>autoindex_localtime on;</strong></p>
<p>默认为 off，显示的文件时间为 GMT 时间。</p>
<p>修改为 on， 显示的文件时间为文件的服务器时间。</p>
<p><strong>charset utf-8,gbk;</strong></p>
<p>默认中文目录乱码，添加上解决乱码。</p>
<h3 id="配置实例"><a href="#配置实例" class="headerlink" title="配置实例"></a>配置实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  download.rocc.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root  /usr/share/nginx/html_download ;</span><br><span class="line">        charset utf-8,gbk;</span><br><span class="line">        autoindex on;</span><br><span class="line">        autoindex_localtime on;</span><br><span class="line">        autoindex_exact_size off;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Nginx-状态监控"><a href="#2-Nginx-状态监控" class="headerlink" title="2. Nginx 状态监控"></a>2. Nginx 状态监控</h2><h3 id="stub-status-语法（ngx-http-stub-status-module）"><a href="#stub-status-语法（ngx-http-stub-status-module）" class="headerlink" title="stub_status 语法（ngx_http_stub_status_module）"></a>stub_status 语法（ngx_http_stub_status_module）</h3><p>语法 Syntax ：stub_status;</p>
<p>环境 Context ：server, location</p>
<h3 id="状态字段释义"><a href="#状态字段释义" class="headerlink" title="状态字段释义"></a>状态字段释义</h3><p>Active connections # 当前活动的连接数</p>
<p>accepts    # 当前的总连接数 TCP</p>
<p>handled    # 成功的连接数 TCP</p>
<p>requests    # 总的 http 请求数</p>
<p>Reading    # 请求</p>
<p>Writing    # 响应</p>
<p>Waiting # 等待的请求数，开启了 keepalive</p>
<p>注意, 一次 TCP 的连接，可以发起多次 http 的请求, 如下参数可配置进行验证</p>
<p>keepalive_timeout 0;    # 类似于关闭长连接</p>
<p>keepalive_timeout 65;    # 65s 没有活动则断开连接</p>
<h3 id="配置实例-1"><a href="#配置实例-1" class="headerlink" title="配置实例"></a>配置实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  download.rocc.com;</span><br><span class="line">		access_log off;</span><br><span class="line"></span><br><span class="line">    location /status &#123;</span><br><span class="line">        stub_status;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Nginx-访问控制"><a href="#3-Nginx-访问控制" class="headerlink" title="3. Nginx 访问控制"></a>3. Nginx 访问控制</h2><h3 id="基于-IP-的访问控制-ngx-http-access-module"><a href="#基于-IP-的访问控制-ngx-http-access-module" class="headerlink" title="基于 IP 的访问控制 ngx_http_access_module"></a>基于 IP 的访问控制 ngx_http_access_module</h3><p><strong>允许配置语法</strong></p>
<p>Syntax: allow address | CIDR | unix: | all;</p>
<p>Default: —</p>
<p>Context: http, server, location, limit_except</p>
<p><strong>拒绝配置语法</strong></p>
<p>Syntax: deny address | CIDR | unix: | all;</p>
<p>Default: —</p>
<p>Context: http, server, location, limit_except</p>
<p><strong>配置实例（只允许 3.3.3.1 访问，其他全部拒绝）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F; &#123;</span><br><span class="line">……                  # 省略</span><br><span class="line">    allow 3.3.3.1;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置实例（只拒绝 3.3.3.0/24 网段访问，其他全部允许访问）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F; &#123;</span><br><span class="line">……                  # 省略</span><br><span class="line">    deny 3.3.3.0&#x2F;24;</span><br><span class="line">    allow all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基于用户登录认证的访问控制-ngx-http-auth-basic-module"><a href="#基于用户登录认证的访问控制-ngx-http-auth-basic-module" class="headerlink" title="基于用户登录认证的访问控制 ngx_http_auth_basic_module"></a>基于用户登录认证的访问控制 ngx_http_auth_basic_module</h3><p><strong>访问提示字符串语法</strong></p>
<p>Syntax: auth_basic string | off;</p>
<p>Default: auth_basic off;</p>
<p>Context: http, server, location, limit_except</p>
<p><strong>账户密码文件语法</strong></p>
<p>Syntax: auth_basic_user_file file;</p>
<p>Default: -</p>
<p>Context: http, server, location, limit_except</p>
<p><strong>配置实例</strong></p>
<p>需要安装 httpd-tools，该包中携带了 htpasswd 命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd-tools -y</span><br></pre></td></tr></table></figure>

<p>创建新的密码文件, -c 创建新文件 -b 允许命令行输入密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -b -c &#x2F;etc&#x2F;nginx&#x2F;auth_conf alan linux</span><br></pre></td></tr></table></figure>

<p>配置默认网站配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server;</span><br><span class="line">    server_name  rocc.com;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html ;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        auth_basic &quot;Auth access WWW Input Your Password!&quot;;</span><br><span class="line">        auth_basic_user_file auth_conf;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-请求限制"><a href="#Nginx-请求限制" class="headerlink" title="Nginx 请求限制"></a>Nginx 请求限制</h2><p>语法 (ngx_http_limit_req_module)</p>
<p>Syntax: limit_req_zone key zone=name:size rate=rate;</p>
<p>Default: -</p>
<p>Context: http</p>
<p>引用限速模块</p>
<p>Syntax: limit_conn zone number [burst=number] [nodelay];</p>
<p>Default: -</p>
<p>Context: http, server, location</p>
<p>参数介绍</p>
<p>定义一条规则</p>
<p>limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;</p>
<p>limit_req_zone    # 引用限速模块</p>
<p>$binary_remote_addr    # 判定条件，每个请求的 IP</p>
<p>zone=alan:10m    # 定义一个 zone 名称</p>
<p>rate=1r/s;    # 限制速度，1 秒 1 次</p>
<p>引用一条限速规则</p>
<p>limit_req zone=two burst=5 nodelay;</p>
<p>limit_req    # 引用限速规则语法</p>
<p>zone=alan    # 引用哪一条规则</p>
<p>burst=5    # 令牌桶，允许排队的数量</p>
<p>nodelay;    # 如果不希望在请求被限制时延迟过多的请求，则应使用参数 nodelay</p>
<p><strong>配置实例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">limit_req_zone $binary_remote_addr zone&#x3D;alan:10m rate&#x3D;1r&#x2F;s;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server;</span><br><span class="line">    server_name  rocc.com;</span><br><span class="line">    limit_req zone&#x3D;alan burst&#x3D;3 nodelay;</span><br><span class="line">access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;www.access.log  main;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html ;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-Location"><a href="#Nginx-Location" class="headerlink" title="Nginx Location"></a>Nginx Location</h2><p>Location 语法</p>
<p>Syntax:    location [ = | ~ | <del>* | ^</del> ] uri { … }</p>
<p>location @name { … }</p>
<p>Default:    —</p>
<p>Context:    server, location</p>
<p>Location 语法优先级排序</p>
<h3 id="配置实例测试-Location-优先级"><a href="#配置实例测试-Location-优先级" class="headerlink" title="配置实例测试 Location 优先级"></a>配置实例测试 Location 优先级</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> server_name  rocc.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        rewrite ^  weibo.com ;</span><br><span class="line">    &#125;</span><br><span class="line">    location = / &#123;</span><br><span class="line">        rewrite ^  &lt;https://weibo.com/?topnav=1&amp;mod=logo&gt; ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /documents/ &#123;</span><br><span class="line">        rewrite ^  &lt;http://www.baidu.com&gt; ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location ^~ /q &#123;</span><br><span class="line">        rewrite ^  &lt;https://www.qq.com/?fromdefault&gt; ;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~* \\.(gif|jpg|jpeg)$ &#123;</span><br><span class="line">        rewrite ^  &lt;https://fanyi.baidu.com/?aldtype=16047<span class="comment">#auto/zh/&gt; ;</span></span><br><span class="line">    &#125;</span><br><span class="line">    location ~ \\.mp4$ &#123;</span><br><span class="line">        rewrite ^  &lt;https://man.linuxde.net/&gt; ;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~* /* &#123;</span><br><span class="line">        rewrite ^  &lt;http://www.baidu.com&gt; ;</span><br><span class="line">    &#125;</span><br><span class="line">    access_log off;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h1><h2 id="代理介绍"><a href="#代理介绍" class="headerlink" title="代理介绍"></a>代理介绍</h2><p><strong>现实生活中代理的场景:</strong></p>
<p>房东</p>
<p>订票平台</p>
<p><strong>正向代理与反向代理</strong></p>
<p>以访问 Google 为例，客户端连接到 VPN 相当于正向代理。</p>
<p>VPN 代理请求访问后端服务器并返回属于反向代理。</p>
<h2 id="Nginx-反向代理参数解释"><a href="#Nginx-反向代理参数解释" class="headerlink" title="Nginx 反向代理参数解释"></a>Nginx 反向代理参数解释</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header Host <span class="variable">$http_host</span>; </span><br><span class="line"><span class="comment"># lb 服务器将用户访问网站的 HOST 信息传递后后端的 web 服务器</span></span><br><span class="line"></span><br><span class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;    </span><br><span class="line"><span class="comment"># 将用户的真实 IP 传递给后端的 web 服务器</span></span><br><span class="line"></span><br><span class="line">proxy_connect_timeout 30;  <span class="comment"># 代理与后端服务器连接超时时间(代理连接超时)</span></span><br><span class="line">proxy_send_timeout 60;     <span class="comment"># 后端服务器数据回传给 nginx 代理超时时间</span></span><br><span class="line">proxy_read_timeout 60;     <span class="comment"># 代理等待后端服务器的响应时间</span></span><br><span class="line"></span><br><span class="line">proxy_buffering on;               </span><br><span class="line"><span class="comment"># 把后端返回的内容先放到缓冲区当中，然后再返回给客户端,边收边传,不是全部接收完再传给客户端</span></span><br><span class="line"></span><br><span class="line">proxy_buffer_size 32k;     <span class="comment"># 设置 nginx 代理保存用户头信息的缓冲区大小</span></span><br><span class="line">proxy_buffers 4 128k;      <span class="comment"># proxy_buffers 缓冲区</span></span><br></pre></td></tr></table></figure>

<h2 id="优化代理配置文件"><a href="#优化代理配置文件" class="headerlink" title="优化代理配置文件"></a>优化代理配置文件</h2><p>将配置写入新文件，调用时使用 include 引用即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/proxy_params &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">proxy_connect_timeout 30;</span><br><span class="line">proxy_send_timeout 60;</span><br><span class="line">proxy_read_timeout 60;</span><br><span class="line">proxy_buffering on;</span><br><span class="line">proxy_buffer_size 32k;</span><br><span class="line">proxy_buffers 4 128k;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-反向代理实践"><a href="#Nginx-反向代理实践" class="headerlink" title="Nginx 反向代理实践"></a>Nginx 反向代理实践</h2><p>lb01            10.0.0.11</p>
<p>web01    10.0.0.21</p>
<p>需求：访问 lb01 的 80 端口代理到 web01 的 8080 端口</p>
<h3 id="web01-配置"><a href="#web01-配置" class="headerlink" title="web01 配置"></a>web01 配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/conf.d/web.conf &lt;&lt; EOF</span><br><span class="line">server &#123;</span><br><span class="line">    listen 8080;</span><br><span class="line"><span class="comment">#    server_name www.rocc.top;</span></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir /code -p</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"web01"</span> &gt; /code/index.html</span><br><span class="line"></span><br><span class="line">nginx -t</span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>

<h3 id="lb01-配置"><a href="#lb01-配置" class="headerlink" title="lb01 配置"></a>lb01 配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy.conf &lt;&lt; EOF</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.rocc.top;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass &lt;http:&#x2F;&#x2F;10.0.0.21:8080&gt;;</span><br><span class="line">        include proxy_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">nginx -t </span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line">echo &#39;10.0.0.11 www.rocc.top&#39; &gt;&gt; &#x2F;etc&#x2F;hosts</span><br></pre></td></tr></table></figure>

<h3 id="测试访问"><a href="#测试访问" class="headerlink" title="测试访问"></a>测试访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl www.rocc.top</span><br></pre></td></tr></table></figure>



<h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><h2 id="为什么需要负载均衡"><a href="#为什么需要负载均衡" class="headerlink" title="为什么需要负载均衡"></a>为什么需要负载均衡</h2><p>我们的 Web 服务器直接面向用户，往往要承载大量并发请求，单台服务器难以负荷。</p>
<p>我使用多台 WEB 服务器组成集群，前端使用 Nginx 负载均衡，将请求分散的打到我们的后端服务器集群中实现负载的分发。</p>
<p>那么会大大提升系统的吞吐率、请求性能、高容灾。</p>
<h2 id="负载均衡和反向代理的关系"><a href="#负载均衡和反向代理的关系" class="headerlink" title="负载均衡和反向代理的关系"></a>负载均衡和反向代理的关系</h2><p>因为反向代理多台机器，所以可以达到负载均衡的效果</p>
<h2 id="负载均衡配置场景"><a href="#负载均衡配置场景" class="headerlink" title="负载均衡配置场景"></a>负载均衡配置场景</h2><h3 id="四层负载均衡"><a href="#四层负载均衡" class="headerlink" title="四层负载均衡"></a>四层负载均衡</h3><p>所谓四层负载均衡指的是 OSI 七层模型中的传输层。</p>
<p>Nginx 已经能支持 TCP/IP 的控制，所以只需要对客户端的请求进行 TCP/IP 协议的包转发就可以实现负载均衡。</p>
<p>它的好处是性能非常快、只需要底层进行应用处理，而不需要进行一些复杂的逻辑。</p>
<h3 id="七层负载均衡"><a href="#七层负载均衡" class="headerlink" title="七层负载均衡"></a>七层负载均衡</h3><p>七层负载均衡它是在应用层，那么它可以完成很多应用方面的协议请求。</p>
<p>比如我们说的 http 应用的负载均衡，它可以实现 http 信息的改写、头信息的改写、安全应用规则控制、URL 匹配规则控制、以及转发,rewrite 等等的规则。</p>
<p>所以在应用层的服务里面，我们可以做的内容就更多，那么 Nginx 则是一个典型的七层负载均衡。</p>
<h3 id="四层与七层负载均衡对比"><a href="#四层与七层负载均衡对比" class="headerlink" title="四层与七层负载均衡对比"></a>四层与七层负载均衡对比</h3><p>四层负载均衡数据包在底层就进行了分发，而七层负载均衡数据包则是在最顶层进行分发</p>
<p>由此可以看出，七层负载均衡效率没有四负载均衡高。</p>
<p>但七层负载均衡更贴近于服务。</p>
<p>如:http 协议就是七层协议，我们可以用 Nginx 可以作会话保持，URL 路径规则匹配、head 头改写等等</p>
<p>这些是四层负载均衡无法实现的。</p>
<h2 id="Nginx-负载均衡实践"><a href="#Nginx-负载均衡实践" class="headerlink" title="Nginx 负载均衡实践"></a>Nginx 负载均衡实践</h2><h3 id="项目需求"><a href="#项目需求" class="headerlink" title="项目需求"></a>项目需求</h3><p>访问 bbs.rocc.top 跳转到 172.16.1.7</p>
<p>访问 <a href="https://www.notion.so/www.rocc.top" target="_blank" rel="noopener">www.rocc.top</a> 跳转到 172.16.1.8</p>
<h3 id="主机目录规划"><a href="#主机目录规划" class="headerlink" title="主机目录规划"></a>主机目录规划</h3><p>lb01            10.0.0.5</p>
<p>web01    172.16.1.7</p>
<p>web02    172.16.1.8</p>
<h3 id="Nginx-配置文件"><a href="#Nginx-配置文件" class="headerlink" title="Nginx 配置文件"></a>Nginx 配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/conf.d/www.conf &lt;&lt; EOF</span><br><span class="line">server &#123;</span><br><span class="line">    server_name www.rocc.top;</span><br><span class="line">    listen 80;</span><br><span class="line">    root /code/;</span><br><span class="line">    index www.html;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/nginx/conf.d/bbs.conf &lt;&lt; EOF</span><br><span class="line">server &#123;</span><br><span class="line">    server_name bbs.rocc.top;</span><br><span class="line">    listen 80;</span><br><span class="line">    root /code/;</span><br><span class="line">    index bbs.html;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="生成测试页面"><a href="#生成测试页面" class="headerlink" title="生成测试页面"></a>生成测试页面</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$(hostname)</span> bbs"</span> &gt; /code/bbs.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$(hostname)</span> www"</span> &gt; /code/www.html</span><br></pre></td></tr></table></figure>

<h3 id="Web-服务器测试访问"><a href="#Web-服务器测试访问" class="headerlink" title="Web 服务器测试访问"></a>Web 服务器测试访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">systemctl restart nginx</span><br><span class="line">curl -H <span class="string">'Host:www.rocc.top'</span> 127.0.0.1</span><br><span class="line">curl -H <span class="string">'Host:bbs.rocc.top'</span> 127.0.0.1</span><br></pre></td></tr></table></figure>

<h3 id="lb-服务器-nginx-配置"><a href="#lb-服务器-nginx-配置" class="headerlink" title="lb 服务器 nginx 配置"></a>lb 服务器 nginx 配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/conf.d/proxy.conf &lt;&lt; EOF</span><br><span class="line">upstream bbs_pools&#123;</span><br><span class="line">        server 172.16.1.7;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">upstream www_pools&#123;</span><br><span class="line">        server 172.16.1.8;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.rocc.top;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://www_pools;</span><br><span class="line">        include proxy_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name bbs.rocc.top;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://bbs_pools;</span><br><span class="line">        include proxy_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx -t </span><br><span class="line">systemctl restart nginx</span><br><span class="line">curl -H <span class="string">'Host:www.rocc.top'</span> 10.0.0.5</span><br><span class="line">curl -H <span class="string">'Host:bbs.rocc.top'</span> 10.0.0.5</span><br></pre></td></tr></table></figure>

<h2 id="负载均衡调度算法实验"><a href="#负载均衡调度算法实验" class="headerlink" title="负载均衡调度算法实验"></a>负载均衡调度算法实验</h2><h3 id="Weight-实验"><a href="#Weight-实验" class="headerlink" title="Weight 实验"></a>Weight 实验</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream www_pools &#123;</span><br><span class="line">   server 172.16.1.7 weight=1;</span><br><span class="line">   server 172.16.1.8 weight=2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ip-hash-实验"><a href="#ip-hash-实验" class="headerlink" title="ip_hash 实验"></a>ip_hash 实验</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream www_pools &#123;</span><br><span class="line">   ip_hash;</span><br><span class="line">   server 172.16.1.7 ;</span><br><span class="line">   server 172.16.1.8 ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="url-hash-实验"><a href="#url-hash-实验" class="headerlink" title="url_hash 实验"></a>url_hash 实验</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream www_pools &#123;</span><br><span class="line">   <span class="built_in">hash</span>   <span class="variable">$request_uri</span>;  </span><br><span class="line">   server 172.16.1.7 ;</span><br><span class="line">   server 172.16.1.8 ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试命令"><a href="#测试命令" class="headerlink" title="测试命令"></a>测试命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;;<span class="keyword">do</span> curl -s -H <span class="string">"host:www.rocc.top"</span> 127.0.0.1;<span class="keyword">done</span> | grep web02 | wc -l</span><br></pre></td></tr></table></figure>

<h2 id="负载均衡配置参数实验"><a href="#负载均衡配置参数实验" class="headerlink" title="负载均衡配置参数实验"></a>负载均衡配置参数实验</h2><h3 id="Down-参数"><a href="#Down-参数" class="headerlink" title="Down 参数"></a>Down 参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upstream www_pools &#123;</span><br><span class="line">   server 172.16.1.7 down;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Backup-参数"><a href="#Backup-参数" class="headerlink" title="Backup 参数"></a>Backup 参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> upstream www_pools &#123;</span><br><span class="line">   server 172.16.1.7 down;</span><br><span class="line">   server 172.16.1.8 backup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="根据条件转发实验"><a href="#根据条件转发实验" class="headerlink" title="根据条件转发实验"></a>根据条件转发实验</h2><h3 id="根据客户端类型转发"><a href="#根据客户端类型转发" class="headerlink" title="根据客户端类型转发"></a>根据客户端类型转发</h3><p>需求：</p>
<p>如果用户是 iphone 就跳转到 iphone 页面</p>
<p>如果用户是安卓就跳转到安卓页面</p>
<p>如果用户是 pc 就跳转到 pc 页面</p>
<p>如果用户是 IE 就返回 403</p>
<p><strong>Web 服务器 nginx 配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/conf.d/sj.conf &lt;&lt; EOF</span><br><span class="line">server &#123;</span><br><span class="line">    listen 8080;</span><br><span class="line">    server_name sj.rocc.top;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/android;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 8081;</span><br><span class="line">    server_name sj.rocc.top;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/iphone;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 8082;</span><br><span class="line">    server_name sj.rocc.top;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/pc;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>生成测试页面</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /code/&#123;android,iphone,pc&#125;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$(hostname)</span> PC"</span> &gt; /code/pc/index.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$(hostname)</span> Iphone"</span> &gt; /code/iphone/index.html</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$(hostname)</span> Android"</span> &gt; /code/android/index.html</span><br><span class="line">nginx -t</span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p><strong>lb 服务器配置 nginx</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/conf.d/sj.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">upstream android &#123;</span><br><span class="line">    server 172.16.1.8:8080;</span><br><span class="line">&#125;</span><br><span class="line">upstream iphone &#123;</span><br><span class="line">    server 172.16.1.7:8081;</span><br><span class="line">&#125;</span><br><span class="line">upstream pc &#123;</span><br><span class="line">    server 172.16.1.7:8082;</span><br><span class="line">    server 172.16.1.8:8082;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name sj.rocc.top;</span><br><span class="line">    location / &#123;</span><br><span class="line">        <span class="comment">#默认跳转至 pc 站点</span></span><br><span class="line">        proxy_pass &lt;http://pc&gt;;</span><br><span class="line">        include proxy_params;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#如果客户端是 Iphone 则跳转到 iphone 的资源池</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">"Iphone"</span>) &#123;</span><br><span class="line">            proxy_pass &lt;http://iphone&gt;;</span><br><span class="line">        &#125; </span><br><span class="line">    </span><br><span class="line">        <span class="comment">#如果客户端是 Android 则跳转到 android 的资源池</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">"Android"</span>)&#123;</span><br><span class="line">            proxy_pass &lt;http://android&gt;;</span><br><span class="line">        &#125; </span><br><span class="line">    </span><br><span class="line">        <span class="comment">#如果客户端是 IE 浏览器，则返回 403 错误。</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">"msie"</span>)&#123;</span><br><span class="line">            <span class="built_in">return</span> 403;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>检查并重启 nginx</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p><strong>测试访问</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"10.0.0.5 sj.oldboy.com"</span> &gt;&gt; /etc/hosts </span><br><span class="line">curl sj.oldboy.com</span><br><span class="line">curl -A <span class="string">"iphone"</span> sj.rocc.top      </span><br><span class="line">curl -A <span class="string">"android"</span> sj.rocc.top </span><br><span class="line">curl -A <span class="string">"msie"</span> sj.rocc.top</span><br></pre></td></tr></table></figure>

<h3 id="根据文件类型转发"><a href="#根据文件类型转发" class="headerlink" title="根据文件类型转发"></a>根据文件类型转发</h3><p>需求</p>
<p>访问图片格式就跳转到web01</p>
<p>访问其他地址就跳转到web02</p>
<p><strong>Web 服务器配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/conf.d/www.conf &lt;&lt; EOF</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.rocc.top;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>生成测试页面</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$(hostname)</span> www"</span> &gt; /code/index.html</span><br><span class="line"><span class="built_in">cd</span> /code/ &amp;&amp; wget -O sun.jpg &lt;http://pic.51yuansu.com/pic3/cover/02/27/64/59c008e1c7954_610.jpg&gt;</span><br></pre></td></tr></table></figure>

<p><strong>lb 服务器 nginx 配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/conf.d/jpg.conf &lt;&lt; EOF</span><br><span class="line">upstream static &#123;</span><br><span class="line">    server 172.16.1.7;</span><br><span class="line">&#125;</span><br><span class="line">upstream default &#123;</span><br><span class="line">    server 172.16.1.8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.rocc.top;</span><br><span class="line">    location / &#123;</span><br><span class="line">            proxy_pass &lt;http://default&gt;;</span><br><span class="line">             include proxy_params;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ .*.(gif|jpg|jpeg|png|bmp|swf|css|js)$ &#123;</span><br><span class="line">            proxy_pass &lt;http://static&gt;;</span><br><span class="line">            include proxy_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>访问测试</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl www.rocc.top</span><br><span class="line">curl www.rocc.top/sun.jpg</span><br></pre></td></tr></table></figure>



<h1 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h1><h2 id="影响性能的主要因素"><a href="#影响性能的主要因素" class="headerlink" title="影响性能的主要因素"></a>影响性能的主要因素</h2><p>1、网络</p>
<ul>
<li>网络的流量</li>
<li>网络是否丢包</li>
<li>这些会影响 http 的请求与调用</li>
</ul>
<p>2、系统</p>
<ul>
<li>硬件有没有磁盘损坏，磁盘速率</li>
<li>系统的负载、内存、系统稳定性</li>
</ul>
<p>3、服务</p>
<ul>
<li>连接优化、请求优化</li>
<li>根据业务形态做对应的服务设置</li>
</ul>
<p>4、程序</p>
<ul>
<li>接口性能</li>
<li>处理速度</li>
<li>程序执行效率</li>
</ul>
<p>5、数据库</p>
<p>每个架构服务与服务之间都或多或少有一些关联，我们需要将整个架构进行分层，找到对应系统或服务的短板，然后进行优化。</p>
<h2 id="系统性能优化"><a href="#系统性能优化" class="headerlink" title="系统性能优化"></a>系统性能优化</h2><p>文件句柄（文件描述符），Linux 一切皆文件，文件句柄可以理解为就是一个索引。</p>
<ul>
<li>文件句柄会随着我们进程的调用频繁增加</li>
<li>系统默认文件句柄是有限制的，不能让一个进程无限的调用</li>
<li>需要限制每个进程和每个服务使用多大的文件句柄</li>
<li>文件句柄是必须要调整的优化参数</li>
</ul>
<p>设置方式：</p>
<ul>
<li>系统全局性修改</li>
<li>用户局部性修改</li>
<li>进程局部性修改</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">配置文件 &#x2F;etc&#x2F;security&#x2F;limits.conf</span><br><span class="line"></span><br><span class="line">1、系统全局性修改</span><br><span class="line"># * 代表所有用户</span><br><span class="line">* soft nofile 25535</span><br><span class="line">* hard nofile 25535</span><br><span class="line"></span><br><span class="line">2.用户局部性修改</span><br><span class="line"># 针对 root 用户，soft 仅提醒，hard 限制，nofile 打开最大文件数</span><br><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br><span class="line"></span><br><span class="line">3.进程局部性修改</span><br><span class="line"># 针对 nginx 进程 （nginx 配置文件中设置）</span><br><span class="line">worker_rlimit_nofile 100000</span><br><span class="line"></span><br><span class="line">4.调整内核参数：让 time_wait 状态重用(端口重用)[flag]</span><br><span class="line">vim &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">net.ipv4.tcp_tw_reuse &#x3D; 1</span><br><span class="line">net.ipv4.tcp_timestamps &#x3D; 1</span><br><span class="line"></span><br><span class="line"># 查看添加的内核参数</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"># 查看所有内核参数</span><br><span class="line">sysctl -a</span><br></pre></td></tr></table></figure>

<p>在高并发短连接的 TCP 服务器上，当服务器处理完请求后立刻主动正常关闭连接。这个场景下会出现大量 socket 处于 TIME_WAIT 状态。如果客户端的并发量持续很高，此时部分客户端就会显示连接不上。 我来解释下这个场景。主动正常关闭 TCP 连接，都会出现 TIMEWAIT。</p>
<p>为什么我们要关注这个高并发短连接呢？有两个方面需要注意：</p>
<ol>
<li>高并发可以让服务器在短时间范围内同时占用大量端口，而端口有个 <code>0 ~ 65535</code> 的范围，并不是很多，刨除系统和其他服务要用的，剩下的就更少了。</li>
<li>在这个场景中，短连接表示业务处理 + 传输数据的时间远远小于 <code>TIMEWAIT</code> 超时的时间的连接</li>
</ol>
<p>这里有个相对长短的概念，比如取一个 web 页面,<code>1</code> 秒钟的 <code>http</code> 短连接处理完业务，在关闭连接之后，这个业务用过的端口会停留在<code>TIMEWAIT</code> 状态几分钟，而这几分钟，其他<code>HTTP</code>请求来临的时候是无法占用此端口的。单用这个业务计算服务器的利用率会发现，服务器干正经事的时间和端口（资源）被挂着无法被使用的时间的比例是 1：几百，服务器资源严重浪费。（说个题外话，从这个意义出发来考虑服务器性能调优的话，长连接业务的服务就不需要考虑<code>TIMEWAIT</code>状态。同时，假如你对服务器业务场景非常熟悉，你会发现，在实际业务场景中，一般长连接对应的业务的并发量并不会很高。</p>
<h2 id="Nginx-性能优化"><a href="#Nginx-性能优化" class="headerlink" title="Nginx 性能优化"></a>Nginx 性能优化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="comment"># cpu 亲和</span></span><br><span class="line"><span class="comment"># nginx 进程数，建议按照 cpu 的核心数来指定</span></span><br><span class="line">worker_processes auto;</span><br><span class="line"><span class="comment"># 将不同的进程绑定到不同的 CPU 核心</span></span><br><span class="line">worker_cpu_affinity auto;</span><br><span class="line"></span><br><span class="line"><span class="comment"># worker 进程的最大打开文件数</span></span><br><span class="line">worker_rlimit_nofile 30000</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">  <span class="comment"># 网络 i/o 模型</span></span><br><span class="line">  use epoll;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 调整 Nginx 单个进程允许的客户端最大连接数（max_clients = worker_processes * worker_connections）</span></span><br><span class="line">  worker_connections 10000;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 默认情况下，Nginx 进程只会在一个时刻接收一个新的连接，我们可以配置 multi_accept 为 on，实现在一个时刻内可以接收多个新的连接，提高处理效率。该参数默认是 off，建议开启。</span></span><br><span class="line">  multi_accept on;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 指定使用 utf-8 字符集</span></span><br><span class="line">    charset utf-8;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    log_format json <span class="string">'&#123; "time_local": "$time_local", '</span></span><br><span class="line">                             <span class="string">'"remote_addr": "$remote_addr", '</span></span><br><span class="line">                             <span class="string">'"referer": "$http_referer", '</span></span><br><span class="line">                             <span class="string">'"request": "$request", '</span></span><br><span class="line">                             <span class="string">'"status": $status, '</span></span><br><span class="line">                             <span class="string">'"bytes": $body_bytes_sent, '</span></span><br><span class="line">                             <span class="string">'"agent": "$http_user_agent", '</span></span><br><span class="line">                             <span class="string">'"x_forwarded": "$http_x_forwarded_for", '</span></span><br><span class="line">                             <span class="string">'"up_addr": "$upstream_addr",'</span></span><br><span class="line">                             <span class="string">'"up_host": "$upstream_http_host",'</span></span><br><span class="line">                             <span class="string">'"upstream_time": "$upstream_response_time",'</span></span><br><span class="line">                             <span class="string">'"request_time": "$request_time"'</span></span><br><span class="line">       <span class="string">' &#125;'</span>;</span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  json;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启文件的高效传输</span></span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 静态资源服务时建议开启</span></span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态资源服务时建议开启</span></span><br><span class="line">    tcp_nodelay        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Gzip 压缩模块</span></span><br><span class="line">    gzip  on;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 关闭 IE 6 版本的压缩（IE 6 不支持压缩）</span></span><br><span class="line">    gzip_disable <span class="string">"MSIE [1-6]\\."</span>;</span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Virtal Server </span></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更详细的 Nginx 参数性能优化参考 <a href="https://segmentfault.com/a/1190000017933715" target="_blank" rel="noopener">https://segmentfault.com/a/1190000017933715</a></p>
<h3 id="优化-Nginx-进程数量"><a href="#优化-Nginx-进程数量" class="headerlink" title="优化 Nginx 进程数量"></a>优化 Nginx 进程数量</h3><p>配置参数如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 1; <span class="comment"># 指定 Nginx 要开启的进程数，结尾的数字就是进程的个数，可以为 auto</span></span><br></pre></td></tr></table></figure>

<p>这个参数调整的是 Nginx 服务的 worker 进程数，Nginx 有 Master 进程和 worker 进程之分，Master 为管理进程、真正接待“顾客”的是 worker 进程。</p>
<p>进程个数的策略：worker 进程数可以设置为等于 CPU 的核数。高流量高并发场合也可以考虑将进程数提高至 CPU 核数 x 2。这个参数除了要和 CPU 核数匹配之外，也与硬盘存储的数据及系统的负载有关，设置为 CPU 核数是个好的起始配置，也是官方建议的。</p>
<p>当然，如果想省麻烦也可以配置为<code>worker_processes auto;</code>，将由 Nginx 自行决定 worker 数量。当访问量快速增加时，Nginx 就会临时 fork 新进程来缩短系统的瞬时开销和降低服务的时间。</p>
<h3 id="将不同的进程绑定到不同的CPU"><a href="#将不同的进程绑定到不同的CPU" class="headerlink" title="将不同的进程绑定到不同的CPU"></a>将不同的进程绑定到不同的CPU</h3><p>默认情况下，Nginx 的多个进程有可能运行在同一个 CPU 核上，导致 Nginx 进程使用硬件的资源不均，这就需要制定进程分配到指定的 CPU 核上处理，达到充分有效利用硬件的目的。配置参数如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 4;</span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;</span><br></pre></td></tr></table></figure>

<p>其中 <code>worker_cpu_affinity</code> 就是配置 Nginx 进程与 CPU 亲和力的参数，即把不同的进程分给不同的 CPU 核处理。这里的<code>0001 0010 0100 1000</code>是掩码，分别代表第1、2、3、4核CPU。上述配置会为每个进程分配一核CPU处理。</p>
<p>当然，如果想省麻烦也可以配置<code>worker_cpu_affinity auto;</code>，将由 Nginx 按需自动分配。</p>
<h3 id="Nginx-事件处理模型优化"><a href="#Nginx-事件处理模型优化" class="headerlink" title="Nginx 事件处理模型优化"></a>Nginx 事件处理模型优化</h3><p>Nginx 的连接处理机制在不同的操作系统中会采用不同的 I/O 模型，在 linux 下，Nginx 使用 epoll 的 I/O 多路复用模型，在 Freebsd 中使用 kqueue 的 I/O 多路复用模型，在 Solaris 中使用 /dev/poll 方式的 I/O 多路复用模型，在 Windows 中使用 icop，等等。</p>
<p>配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">  use epoll;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>events</code> 指令是设定 Nginx 的工作模式及连接数上限。<code>use</code>指令用来指定 Nginx 的工作模式。Nginx 支持的工作模式有 select、 poll、 kqueue、 epoll 、 rtsig 和/ dev/poll。当然，也可以不指定事件处理模型，Nginx 会自动选择最佳的事件处理模型。</p>
<h3 id="单个进程允许的客户端最大连接数"><a href="#单个进程允许的客户端最大连接数" class="headerlink" title="单个进程允许的客户端最大连接数"></a>单个进程允许的客户端最大连接数</h3><p>通过调整控制连接数的参数来调整 Nginx 单个进程允许的客户端最大连接数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">  worker_connections 20480;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>worker_connections</code> 也是个事件模块指令，用于定义 Nginx 每个进程的最大连接数，默认是 1024。</p>
<p>最大连接数的计算公式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_clients = worker_processes * worker_connections;</span><br></pre></td></tr></table></figure>

<p>如果作为反向代理，因为浏览器默认会开启 2 个连接到 server，而且 Nginx 还会使用fds（file descriptor）从同一个连接池建立连接到 upstream 后端。则最大连接数的计算公式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_clients = worker_processes * worker_connections / 4;</span><br></pre></td></tr></table></figure>

<p>另外，<strong>进程的最大连接数受 Linux 系统进程的最大打开文件数限制</strong>，在执行操作系统命令 <code>ulimit -HSn 65535</code>或配置相应文件后， <code>worker_connections</code> 的设置才能生效。</p>
<h3 id="配置获取更多连接数"><a href="#配置获取更多连接数" class="headerlink" title="配置获取更多连接数"></a>配置获取更多连接数</h3><p>默认情况下，Nginx 进程只会在一个时刻接收一个新的连接，我们可以配置<code>multi_accept</code> 为 <code>on</code>，实现在一个时刻内可以接收多个新的连接，提高处理效率。该参数默认是 <code>off</code>，建议开启。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">  multi_accept on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置-worker-进程的最大打开文件数"><a href="#配置-worker-进程的最大打开文件数" class="headerlink" title="配置 worker 进程的最大打开文件数"></a>配置 worker 进程的最大打开文件数</h3><p>调整配置 Nginx worker 进程的最大打开文件数，这个控制连接数的参数为<code>worker_rlimit_nofile</code>。该参数的实际配置如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_nofile 65535;</span><br></pre></td></tr></table></figure>

<p>可设置为系统优化后的 <code>ulimit -HSn</code> 的结果。</p>
<h3 id="优化域名的散列表大小"><a href="#优化域名的散列表大小" class="headerlink" title="优化域名的散列表大小"></a>优化域名的散列表大小</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  server_names_hash_bucket_size 128;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数作用:设置存放域名( server names)的最大散列表的存储桶( bucket)的大小。 默认值依赖 CPU 的缓存行。</p>
<p><code>server_names_hash_bucket_size</code> 的值是不能带单位 的。配置主机时必须设置该值，否则无法运行 Nginx，或者无法通过测试 。 该设置与 <code>server_ names_hash_max_size</code> 共同控制保存服务器名的 hash 表， hash bucket size 总是等于 hash 表的大小， 并且是一路处理器缓存大小的倍数。若 hash bucket size 等于一路处理器缓存的大小，那么在查找键时， 最坏的情况下在内存中查找的次数为 2。第一次是确定存储单元的地址，第二次是在存储单元中查找键值 。 若报 出 hash max size 或 hash bucket size 的提示，则需要增加 <code>server_names_hash_max size</code> 的值。</p>
<h3 id="TCP-优化"><a href="#TCP-优化" class="headerlink" title="TCP 优化"></a>TCP 优化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  sendfile on;</span><br><span class="line">  tcp_nopush on;</span><br><span class="line"></span><br><span class="line">  keepalive_timeout 120;</span><br><span class="line">  tcp_nodelay on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一行的 <code>sendfile</code> 配置可以提高 Nginx 静态资源托管效率。sendfile 是一个系统调用，直接在内核空间完成文件发送，不需要先 read 再 write，没有上下文切换开销。</p>
<p>TCP_NOPUSH 是 FreeBSD 的一个 socket 选项，对应 Linux 的 TCP_CORK，Nginx 里统一用 <code>tcp_nopush</code> 来控制它，并且只有在启用了 <code>sendfile</code> 之后才生效。启用它之后，数据包会累计到一定大小之后才会发送，减小了额外开销，提高网络效率。</p>
<p>TCP_NODELAY 也是一个 socket 选项，启用后会禁用 Nagle 算法，尽快发送数据，某些情况下可以节约 200ms（Nagle 算法原理是：在发出去的数据还未被确认之前，新生成的小数据先存起来，凑满一个 MSS 或者等到收到确认后再发送）。Nginx 只会针对处于 keep-alive 状态的 TCP 连接才会启用 <code>tcp_nodelay</code>。</p>
<h3 id="优化连接参数"><a href="#优化连接参数" class="headerlink" title="优化连接参数"></a>优化连接参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  client_header_buffer_size 32k;</span><br><span class="line">  large_client_header_buffers 4 32k;</span><br><span class="line">  client_max_body_size 1024m;</span><br><span class="line">  client_body_buffer_size 10m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分更多是更具业务场景来决定的。例如<code>client_max_body_size</code>用来决定请求体的大小，用来限制上传文件的大小。上面列出的参数可以作为起始参数。</p>
<h3 id="配置压缩优化"><a href="#配置压缩优化" class="headerlink" title="配置压缩优化"></a>配置压缩优化</h3><p><strong>Gzip 压缩</strong></p>
<p>我们在上线前，代码（JS、CSS 和 HTML）会做压缩，图片也会做压缩（PNGOUT、Pngcrush、JpegOptim、Gifsicle 等）。对于文本文件，在服务端发送响应之前进行 GZip 压缩也很重要，通常压缩后的文本大小会减小到原来的 1/4 - 1/3。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  gzip on;</span><br><span class="line">  gzip_buffers 16 8k;</span><br><span class="line">  gzip_comp_level 6;</span><br><span class="line">  gzip_http_version 1.0;</span><br><span class="line">  gzip_min_length 1000;</span><br><span class="line">  gzip_proxied any;</span><br><span class="line">  gzip_vary on;</span><br><span class="line">  gzip_types</span><br><span class="line">    text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml</span><br><span class="line">    text/javascript application/javascript application/x-javascript</span><br><span class="line">    text/x-json application/json application/x-web-app-manifest+json</span><br><span class="line">    text/css text/plain text/x-component</span><br><span class="line">    font/opentype application/x-font-ttf application/vnd.ms-fontobject</span><br><span class="line">    image/x-icon;</span><br><span class="line">  gzip_disable <span class="string">"MSIE [1-6]\\.(?!.*SV1)"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分内容比较简单，只有两个地方需要解释下：</p>
<p><code>gzip_vary</code> 用来输出 Vary 响应头，用来解决某些缓存服务的一个问题，详情请看我之前的博客：HTTP 协议中 Vary 的一些研究。</p>
<p><code>gzip_disable</code> 指令接受一个正则表达式，当请求头中的 UserAgent 字段满足这个正则时，响应不会启用 GZip，这是为了解决在某些浏览器启用 GZip 带来的问题。</p>
<p>默认 Nginx 只会针对 HTTP/1.1 及以上的请求才会启用 GZip，因为部分早期的 HTTP/1.0 客户端在处理 GZip 时有 Bug。现在基本上可以忽略这种情况，于是可以指定 gzip_http_version 1.0 来针对 HTTP/1.0 及以上的请求开启 GZip。</p>
<p><strong>Brotli 压缩</strong></p>
<p>Brotli 是基于LZ77算法的一个现代变体、霍夫曼编码和二阶上下文建模。Google软件工程师在2015年9月发布了包含通用无损数据压缩的Brotli增强版本，特别侧重于HTTP压缩。其中的编码器被部分改写以提高压缩比，编码器和解码器都提高了速度，流式API已被改进，增加更多压缩质量级别。</p>
<p>需要安装<code>libbrotli</code>、<code>ngx_brotli</code>，重新编译 Nginx 时，带上<code>--add-module=/path/to/ngx_brotli</code>即可，然后配置如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  brotli on;</span><br><span class="line">  brotli_comp_level 6;</span><br><span class="line">  brotli_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Brotli 可与 Gzip 共存在一个配置文件中。</p>
<h3 id="静态资源优化"><a href="#静态资源优化" class="headerlink" title="静态资源优化"></a>静态资源优化</h3><p>静态资源优化，可以减少连接请求数，同时也不需要对这些资源请求打印日志。但副作用是资源更新可能无法及时。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    <span class="comment"># 图片、视频</span></span><br><span class="line">    location ~ .*\\.(gif|jpg|jpeg|png|bmp|swf|flv|mp4|ico)$ &#123;</span><br><span class="line">      expires 30d;</span><br><span class="line">      access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 字体</span></span><br><span class="line">    location ~ .*\\.(eot|ttf|otf|woff|svg)$ &#123;</span><br><span class="line">      expires 30d;</span><br><span class="line">      access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># js、css</span></span><br><span class="line">    location ~ .*\\.(js|css)?$ &#123;</span><br><span class="line">      expires 7d;</span><br><span class="line">      access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="制作内部网络-yum-仓库"><a href="#制作内部网络-yum-仓库" class="headerlink" title="制作内部网络 yum 仓库"></a>制作内部网络 yum 仓库</h1><p>安装所需的软件 <code>createrepo nginx</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install createrepo nginx -y</span><br></pre></td></tr></table></figure>

<p>配置 nginx 索引模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/nginx/conf.d/yum.conf &lt;&lt; EOF</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server;</span><br><span class="line">    server_name  yum.alan.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        autoindex on;</span><br><span class="line">        autoindex_exact_size off;</span><br><span class="line">        autoindex_localtime on;</span><br><span class="line">        charset utf-8,gbk;</span><br><span class="line">        root    /yum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>准备软件仓库目录并下载需要的软件至该目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install --downloadonly --downloaddir=/yum nginx screen httpd -y</span><br></pre></td></tr></table></figure>

<p>生成 yum 元数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createrepo /yum</span><br></pre></td></tr></table></figure>

<p>客户端生成本地源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/local.repo &lt;&lt; EOF</span><br><span class="line">[<span class="built_in">local</span>]</span><br><span class="line">name=<span class="built_in">local</span></span><br><span class="line"><span class="built_in">enable</span>=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">baseurl=http://172.16.1.11</span><br></pre></td></tr></table></figure>

<p>客户端测试安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br><span class="line">yum install httpd</span><br></pre></td></tr></table></figure>

<p>更新软件包的操作步骤：</p>
<p>第一种方法：真实下载</p>
<p>1.打开 yum 缓存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">"keepcache"</span> /etc/yum.conf </span><br><span class="line">keepcache=1</span><br></pre></td></tr></table></figure>

<p>2.清空原来的缓存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br></pre></td></tr></table></figure>

<p>3.下载软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum remove php-mysql-5.4 php php-fpm php-common</span><br><span class="line">rpm -Uvh &lt;https:&#x2F;&#x2F;dl.fedoraproject.org&#x2F;pub&#x2F;epel&#x2F;epel-release-latest-7.noarch.rpm&gt;</span><br><span class="line">rpm -Uvh &lt;https:&#x2F;&#x2F;mirror.webtatic.com&#x2F;yum&#x2F;el7&#x2F;webtatic-release.rpm&gt;</span><br><span class="line">yum install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache -y</span><br></pre></td></tr></table></figure>

<p>4.移动已经缓存下来的 rpm 包到 yum 仓库目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/cache/yum/ -<span class="built_in">type</span> f -name <span class="string">"*.rpm"</span>|xargs mv -t  /yum/</span><br></pre></td></tr></table></figure>

<p>5.生成新的 yum 元数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createrepo --update  /yum/</span><br></pre></td></tr></table></figure>

<p>第二种方法：只下载不安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install --downloadonly --downloaddir= /yum php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache</span><br></pre></td></tr></table></figure>
</div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/nginx/">nginx</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2018/02/13/Zabbix%20%E7%9B%91%E6%8E%A7/"><img class="prev_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Zabbix 监控</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By ALAN</div><div class="footer_custom_text">yuiya@yahoo.com</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode far fa-sun" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script></body></html>