<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Redis 基础入门 | ALAN</title><meta name="description" content="Redis 非关系型数据库  Redis 是一种基于 键值对 的 NoSQL 数据库。与很多键值对数据库不同，Redis 提供了丰富的 值数据存储结构，包括 string(字符串)、hash(哈希)、list(列表)、set(集合)、zset(有序集合)、bitmap(位图)等等。   常见的数据库类型关系型: mysql oracle  非关系型: mongo redis ES Redis 的重"><meta name="keywords" content="Redis 基础 集群 哨兵模式 主从复制 非关系型数据库 NoSQL"><meta name="author" content="ALAN"><meta name="copyright" content="ALAN"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Redis 基础入门"><meta name="twitter:description" content="Redis 非关系型数据库  Redis 是一种基于 键值对 的 NoSQL 数据库。与很多键值对数据库不同，Redis 提供了丰富的 值数据存储结构，包括 string(字符串)、hash(哈希)、list(列表)、set(集合)、zset(有序集合)、bitmap(位图)等等。   常见的数据库类型关系型: mysql oracle  非关系型: mongo redis ES Redis 的重"><meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Redis 基础入门"><meta property="og:url" content="https://rocc.top/2018/11/23/Redis%20%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/"><meta property="og:site_name" content="ALAN"><meta property="og:description" content="Redis 非关系型数据库  Redis 是一种基于 键值对 的 NoSQL 数据库。与很多键值对数据库不同，Redis 提供了丰富的 值数据存储结构，包括 string(字符串)、hash(哈希)、list(列表)、set(集合)、zset(有序集合)、bitmap(位图)等等。   常见的数据库类型关系型: mysql oracle  非关系型: mongo redis ES Redis 的重"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2018-11-22T17:01:52.000Z"><meta property="article:modified_time" content="2020-06-15T09:20:56.264Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://rocc.top/2018/11/23/Redis%20%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/"><link rel="prev" title="Python 基础入门" href="https://rocc.top/2019/03/20/Python%20%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/"><link rel="next" title="Zabbix 监控" href="https://rocc.top/2018/02/13/Zabbix%20%E7%9B%91%E6%8E%A7/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://rocc.top/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"Press","message_next":"to bookmark this page"},"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: true,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/cc-001.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">9</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="https://download.rocc.top" target="_blank" rel="noopener"><i class="fa-fw fa fa-download"></i><span> Download</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-非关系型数据库"><span class="toc-number">1.</span> <span class="toc-text">Redis 非关系型数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#常见的数据库类型"><span class="toc-number">1.1.</span> <span class="toc-text">常见的数据库类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-的重要特性"><span class="toc-number">1.2.</span> <span class="toc-text">Redis 的重要特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-速度快-读写性能优异"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.速度快, 读写性能优异</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-基于键值对的数据结构-支持多种数据类型"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.基于键值对的数据结构,支持多种数据类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-丰富的功能"><span class="toc-number">1.2.3.</span> <span class="toc-text">3.丰富的功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-简单稳定"><span class="toc-number">1.2.4.</span> <span class="toc-text">4.简单稳定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-客户端语言多"><span class="toc-number">1.2.5.</span> <span class="toc-text">5.客户端语言多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-数据持久化"><span class="toc-number">1.2.6.</span> <span class="toc-text">6.数据持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-主从复制"><span class="toc-number">1.2.7.</span> <span class="toc-text">7.主从复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-高可用和分布式"><span class="toc-number">1.2.8.</span> <span class="toc-text">8.高可用和分布式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-的应用场景"><span class="toc-number">1.3.</span> <span class="toc-text">Redis 的应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-缓存-键过期时间"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.缓存-键过期时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-排行榜-列表-amp-有序集合"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.排行榜-列表&amp;有序集合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-计数器应用-天然支持计数器"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.计数器应用-天然支持计数器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-社交网络-集合"><span class="toc-number">1.3.4.</span> <span class="toc-text">4.社交网络-集合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-消息队列系统-发布订阅"><span class="toc-number">1.3.5.</span> <span class="toc-text">5.消息队列系统-发布订阅</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-安装部署"><span class="toc-number">2.</span> <span class="toc-text">Redis 安装部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#源码编译安装"><span class="toc-number">2.1.</span> <span class="toc-text">源码编译安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置文件主要参数说明"><span class="toc-number">2.2.</span> <span class="toc-text">配置文件主要参数说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#快速在多台主机上部署-Redis"><span class="toc-number">2.3.</span> <span class="toc-text">快速在多台主机上部署 Redis</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-基础命令"><span class="toc-number">3.</span> <span class="toc-text">Redis 基础命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#字符串-String"><span class="toc-number">3.1.</span> <span class="toc-text">字符串 ( String )</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#列表-List"><span class="toc-number">3.2.</span> <span class="toc-text">列表 ( List )</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#哈希-Hash"><span class="toc-number">3.3.</span> <span class="toc-text">哈希 ( Hash )</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集合-Set"><span class="toc-number">3.4.</span> <span class="toc-text">集合 ( Set )</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#有序集合-zset"><span class="toc-number">3.5.</span> <span class="toc-text">有序集合 ( zset )</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-用户认证"><span class="toc-number">4.</span> <span class="toc-text">Redis 用户认证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-持久化"><span class="toc-number">5.</span> <span class="toc-text">Redis 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RDB-方式持久化"><span class="toc-number">5.1.</span> <span class="toc-text">RDB  方式持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOF-方式持久化"><span class="toc-number">5.2.</span> <span class="toc-text">AOF  方式持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#性能与实践"><span class="toc-number">5.3.</span> <span class="toc-text">性能与实践</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-主从复制"><span class="toc-number">6.</span> <span class="toc-text">Redis 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置主从坏境"><span class="toc-number">6.1.</span> <span class="toc-text">配置主从坏境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Master-主服务器-db01-配置"><span class="toc-number">6.1.1.</span> <span class="toc-text">Master 主服务器 db01 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Slave-01-从服务器-db02-配置"><span class="toc-number">6.1.2.</span> <span class="toc-text">Slave-01 从服务器 db02 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Slave-02-从服务器-db03-配置"><span class="toc-number">6.1.3.</span> <span class="toc-text">Slave-02 从服务器 db03 配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#主从复制流程"><span class="toc-number">6.2.</span> <span class="toc-text">主从复制流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-sentinel-哨兵模式"><span class="toc-number">7.</span> <span class="toc-text">Redis sentinel 哨兵模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-Sentinel-搭建"><span class="toc-number">7.1.</span> <span class="toc-text">Redis Sentinel 搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-Sentinel-的主要功能"><span class="toc-number">7.2.</span> <span class="toc-text">Redis Sentinel 的主要功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-集群"><span class="toc-number">8.</span> <span class="toc-text">Redis 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#集群的基本概念"><span class="toc-number">8.1.</span> <span class="toc-text">集群的基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署集群"><span class="toc-number">8.2.</span> <span class="toc-text">部署集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在每台主机-db01、db02、db03-上配置两个实例"><span class="toc-number">8.2.1.</span> <span class="toc-text">在每台主机(db01、db02、db03)上配置两个实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#手动配置集群"><span class="toc-number">8.2.2.</span> <span class="toc-text">手动配置集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-集群各节点互相发现"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">1.集群各节点互相发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-分配槽位"><span class="toc-number">8.2.2.2.</span> <span class="toc-text">2.分配槽位</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-配置复制关系"><span class="toc-number">8.2.2.3.</span> <span class="toc-text">3.配置复制关系</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自动配置集群"><span class="toc-number">8.2.3.</span> <span class="toc-text">自动配置集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群扩容和收缩"><span class="toc-number">8.3.</span> <span class="toc-text">集群扩容和收缩</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#增配-2-个实例"><span class="toc-number">8.3.1.</span> <span class="toc-text">增配 2 个实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用工具扩容和收缩"><span class="toc-number">8.3.2.</span> <span class="toc-text">使用工具扩容和收缩</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-cli–cluster-集群命令"><span class="toc-number">8.4.</span> <span class="toc-text">redis-cli–cluster 集群命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据迁移"><span class="toc-number">8.5.</span> <span class="toc-text">数据迁移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分析-KEY-的大小"><span class="toc-number">8.6.</span> <span class="toc-text">分析 KEY 的大小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存管理"><span class="toc-number">8.7.</span> <span class="toc-text">内存管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群相关命令"><span class="toc-number">8.8.</span> <span class="toc-text">集群相关命令</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://download.rocc.top/img/redis-header-img-001.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">ALAN</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="https://download.rocc.top" target="_blank" rel="noopener"><i class="fa-fw fa fa-download"></i><span> Download</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Redis 基础入门</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2018-11-23 01:01:52"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2018-11-23</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-06-15 17:20:56"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-06-15</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Redis-非关系型数据库"><a href="#Redis-非关系型数据库" class="headerlink" title="Redis 非关系型数据库"></a>Redis 非关系型数据库</h1><br>

<p><code>Redis</code> 是一种基于 <strong>键值对</strong> 的 <code>NoSQL</code> 数据库。与很多键值对数据库不同，<code>Redis</code> 提供了丰富的 <strong>值数据存储结构</strong>，包括 <code>string</code>(<strong>字符串</strong>)、<code>hash</code>(<strong>哈希</strong>)、<code>list</code>(<strong>列表</strong>)、<code>set</code>(<strong>集合</strong>)、<code>zset</code>(<strong>有序集合</strong>)、<code>bitmap</code>(<strong>位图</strong>)等等。</p>
<br>

<h2 id="常见的数据库类型"><a href="#常见的数据库类型" class="headerlink" title="常见的数据库类型"></a>常见的数据库类型</h2><p>关系型: mysql oracle </p>
<p>非关系型: mongo redis ES</p>
<h2 id="Redis-的重要特性"><a href="#Redis-的重要特性" class="headerlink" title="Redis 的重要特性"></a>Redis 的重要特性</h2><h3 id="1-速度快-读写性能优异"><a href="#1-速度快-读写性能优异" class="headerlink" title="1.速度快, 读写性能优异"></a>1.速度快, 读写性能优异</h3><p>Redis 所有的数据都存放在内存中 </p>
<p>Redis 使用 c 语言实现 </p>
<p>Redis 使用单线程架构 </p>
<h3 id="2-基于键值对的数据结构-支持多种数据类型"><a href="#2-基于键值对的数据结构-支持多种数据类型" class="headerlink" title="2.基于键值对的数据结构,支持多种数据类型"></a>2.基于键值对的数据结构,支持多种数据类型</h3><p> 5 种数据类型 : 字符串, 哈希, 列表, 集合, 有序集合</p>
<h3 id="3-丰富的功能"><a href="#3-丰富的功能" class="headerlink" title="3.丰富的功能"></a>3.丰富的功能</h3><p>提供了键过期功能,可以实现缓存</p>
<p>提供了发布订阅功能,可以实现消息系统</p>
<p>提供了 pipeline 功能,客户端可以将一批命令一次性传到 Redis,减少了网络开销 </p>
<h3 id="4-简单稳定"><a href="#4-简单稳定" class="headerlink" title="4.简单稳定"></a>4.简单稳定</h3><p>源码较少,3.0 版本以后 <code>5</code> 万行代码左右 </p>
<p>使用单线程模型法,是的 Redis 服务端处理模型变得简单</p>
<p>不依赖操作系统的中的类库 </p>
<h3 id="5-客户端语言多"><a href="#5-客户端语言多" class="headerlink" title="5.客户端语言多"></a>5.客户端语言多</h3><p>java,PHP,python,C,C++,Nodejs 等 </p>
<h3 id="6-数据持久化"><a href="#6-数据持久化" class="headerlink" title="6.数据持久化"></a>6.数据持久化</h3><p> <code>RDB</code> 和 <code>AOF</code></p>
<h3 id="7-主从复制"><a href="#7-主从复制" class="headerlink" title="7.主从复制"></a>7.主从复制</h3><p>分布式的基础</p>
<h3 id="8-高可用和分布式"><a href="#8-高可用和分布式" class="headerlink" title="8.高可用和分布式"></a>8.高可用和分布式</h3><p>哨兵 redis-sentinel </p>
<p>集群 redis-cluster </p>
<h2 id="Redis-的应用场景"><a href="#Redis-的应用场景" class="headerlink" title="Redis 的应用场景"></a>Redis 的应用场景</h2><h3 id="1-缓存-键过期时间"><a href="#1-缓存-键过期时间" class="headerlink" title="1.缓存-键过期时间"></a>1.缓存-键过期时间</h3><p>缓存 <code>session</code> 会话, 过期删除</p>
<p>缓存用户信息, 缓存 MySQL 部分数据, 用户先访问 Redis, 若 Redis 没有则再访问 mysql, 然后回写到 redis</p>
<p>商城优惠卷过期时间</p>
<h3 id="2-排行榜-列表-amp-有序集合"><a href="#2-排行榜-列表-amp-有序集合" class="headerlink" title="2.排行榜-列表&amp;有序集合"></a>2.排行榜-列表&amp;有序集合</h3><p>热度排行</p>
<p>活动积分排行</p>
<h3 id="3-计数器应用-天然支持计数器"><a href="#3-计数器应用-天然支持计数器" class="headerlink" title="3.计数器应用-天然支持计数器"></a>3.计数器应用-天然支持计数器</h3><p>浏览数、播放次数、评论数、点赞数 </p>
<h3 id="4-社交网络-集合"><a href="#4-社交网络-集合" class="headerlink" title="4.社交网络-集合"></a>4.社交网络-集合</h3><p>粉丝，共同好友，兴趣爱好，标签，推送，下拉刷新等是社交网站必备的功能</p>
<h3 id="5-消息队列系统-发布订阅"><a href="#5-消息队列系统-发布订阅" class="headerlink" title="5.消息队列系统-发布订阅"></a>5.消息队列系统-发布订阅</h3><p>发布订阅（<code>PUB/SUB</code>）和 阻塞队列 的功能，虽然和专业的消息队列比，还不够强大，但对于一般的消息队列功能基本满足。如配合 ELK 实现日志收集。<br><br></p>
<h1 id="Redis-安装部署"><a href="#Redis-安装部署" class="headerlink" title="Redis 安装部署"></a>Redis 安装部署</h1><h2 id="源码编译安装"><a href="#源码编译安装" class="headerlink" title="源码编译安装"></a>源码编译安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载源码包</span></span><br><span class="line"><span class="built_in">cd</span> /tmp &amp;&amp; wget https://download.rocc.top/packages/redis/redis-5.0.7.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar xf redis-5.0.7.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入目录</span></span><br><span class="line"><span class="built_in">cd</span> redis-5.0.7/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">yum install gcc gcc-c++</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译并安装</span></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 redis 用户</span></span><br><span class="line">useradd -s /sbin/nologin -M redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 redis 数据目录</span></span><br><span class="line">mkdir /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis -p</span><br><span class="line">chown -R redis: /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line">cat &gt; /etc/redis.conf &lt;&lt; EOF</span><br><span class="line"><span class="comment"># 以守护进程模式启动</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="comment">#绑定的主机地址</span></span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1 `ifconfig eth0 | awk <span class="string">'NR==2&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="comment"># 监听端口</span></span><br><span class="line">port 6379</span><br><span class="line"><span class="comment"># pid 文件和 log 文件地址</span></span><br><span class="line">pidfile /var/run/redis/redis.pid</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis.log</span><br><span class="line"><span class="comment"># 设置数据库的数量，默认数据库为 0</span></span><br><span class="line">databases 16</span><br><span class="line"><span class="comment"># 指定本地持久化文件的文件名,默认是 dump.rdb</span></span><br><span class="line">dbfilename redis.rdb</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"><span class="comment"># 本地数据库的目录,默认是 ./</span></span><br><span class="line">dir /var/lib/redis</span><br><span class="line"><span class="comment"># AOF 重写</span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename redis.aof</span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># 配置连接密码</span></span><br><span class="line">requirepass menglu</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 systemd 启动服务</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/redis.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis persistent key-value database</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/redis-server /etc/redis.conf --supervised systemd</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/bin/redis-cli -p 6379 shutdown</span><br><span class="line">Type=notify</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务并设置为开机自启</span></span><br><span class="line">systemctl start redis &amp;&amp; systemctl <span class="built_in">enable</span> redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入客户端</span></span><br><span class="line">redis-cli</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在客户端中关闭服务</span></span><br><span class="line"><span class="comment"># shutdown</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭服务</span></span><br><span class="line"><span class="comment"># redis-cli shutdown</span></span><br></pre></td></tr></table></figure>

<br>

<h2 id="配置文件主要参数说明"><a href="#配置文件主要参数说明" class="headerlink" title="配置文件主要参数说明"></a>配置文件主要参数说明</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># redis 进程是否以守护进程的方式运行，yes 为是，no 为否(不以守护进程的方式运行会占用一个终端)。</span><br><span class="line">daemonize yes</span><br><span class="line"># 指定 redis 进程的 PID 文件存放位置</span><br><span class="line">pidfile &#x2F;var&#x2F;run&#x2F;redis.pid</span><br><span class="line"># redis 进程的端口号</span><br><span class="line">port 6379</span><br><span class="line"># 绑定的主机地址</span><br><span class="line">bind 127.0.0.1</span><br><span class="line"># 客户端闲置多长时间后关闭连接，默认此参数为 0 即关闭此功能</span><br><span class="line">timeout 300</span><br><span class="line"># redis 日志级别，可用的级别有debug.verbose.notice.warning</span><br><span class="line">loglevel verbose</span><br><span class="line"># log 文件输出位置，如果进程以守护进程的方式运行，此处又将输出文件设置为 stdout 的话，就会将日志信息输出到 &#x2F;dev&#x2F;null</span><br><span class="line">logfile &#x2F;var&#x2F;log&#x2F;redis.log</span><br><span class="line"># 设置数据库的数量，默认为 0 可以使用 select &lt;dbid&gt; 命令在连接上指定数据库 id</span><br><span class="line">databases 16</span><br><span class="line"># 指定在多少时间内刷新次数达到多少的时候会将数据同步到数据文件</span><br><span class="line">save &lt;seconds&gt; &lt;changes&gt;</span><br><span class="line"># 指定存储至本地数据库时是否压缩文件，默认为 yes 即启用存储</span><br><span class="line">rdbcompression yes</span><br><span class="line"># 指定本地数据库文件名</span><br><span class="line">dbfilename dump.db</span><br><span class="line"># 指定本地数据存放位置</span><br><span class="line">dir .&#x2F;</span><br><span class="line"># 指定当本机为 slave 服务时，设置 master 服务的 IP 地址及端口，在 redis 启动的时候他会自动跟 master 进行数据同步</span><br><span class="line">slaveof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line"># 当 master 设置了密码保护时，slave 服务连接 master 的密码</span><br><span class="line">masterauth &lt;master-password&gt;</span><br><span class="line"># 设置 redis 连接密码，如果配置了连接密码，客户端在连接 redis 是需要通过 AUTH &lt;password&gt; 命令提供密码，默认关闭</span><br><span class="line">requirepass footbared</span><br><span class="line"># 设置同一时间最大客户连接数，默认无限制。redis 可以同时连接的客户端数为 redis 程序可以打开的最大文件描述符，如果设置 maxclients 0，表示不作限制。当客户端连接数到达限制时，Redis 会关闭新的连接并向客户端返回 max number of clients reached 错误信息</span><br><span class="line">maxclients 128</span><br><span class="line"># 指定 Redis 最大内存限制，Redis 在启动时会把数据加载到内存中，达到最大内存后，Redis 会先尝试清除已到期或即将到期的 Key。当此方法处理后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作。Redis 新的vm 机制，会把 Key 存放内存，Value 会存放在 swap 区</span><br><span class="line">maxmemory &lt;bytes&gt;</span><br><span class="line"># 指定是否在每次更新操作后进行日志记录，Redis 在默认情况下是异步的把数据写入磁盘，如果不开启，可能会在断电时导致一段时间内的数据丢失。因为 redis 本身同步数据文件是按上面 save 条件来同步的，所以有的数据会在一段时间内只存在于内存中。默认为 no。</span><br><span class="line">appendonly no</span><br><span class="line"># 指定跟新日志文件名默认为 appendonly.aof</span><br><span class="line">appendfilename appendonly.aof</span><br><span class="line"># 指定更新日志的条件，有三个可选参数 no：表示等操作系统进行数据缓存同步到磁盘(快)，always：表示每次更新操作后手动调用 fsync() 将数据写到磁盘(慢，安全)， everysec：表示每秒同步一次(折衷，默认值)；</span><br><span class="line">appendfsync everysec</span><br></pre></td></tr></table></figure>

<br>

<h2 id="快速在多台主机上部署-Redis"><a href="#快速在多台主机上部署-Redis" class="headerlink" title="快速在多台主机上部署 Redis"></a>快速在多台主机上部署 Redis</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 redis 二进制文件复制到目标主机</span></span><br><span class="line">scp /usr/<span class="built_in">local</span>/bin/redis-* 10.0.1.3:/usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 redis 用户</span></span><br><span class="line">useradd -s /sbin/nologin -M redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 redis 数据目录</span></span><br><span class="line">mkdir /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis -p</span><br><span class="line">chown -R redis: /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置文件</span></span><br><span class="line">cat &gt; /etc/redis.conf &lt;&lt; EOF</span><br><span class="line"><span class="comment"># 以守护进程模式启动</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="comment">#绑定的主机地址</span></span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1 `ifconfig eth0 | awk <span class="string">'NR==2&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="comment"># 监听端口</span></span><br><span class="line">port 6379</span><br><span class="line"><span class="comment"># pid 文件和 log 文件地址</span></span><br><span class="line">pidfile /var/run/redis/redis.pid</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis.log</span><br><span class="line"><span class="comment"># 设置数据库的数量，默认数据库为 0</span></span><br><span class="line">databases 16</span><br><span class="line"><span class="comment"># 指定本地持久化文件的文件名,默认是 dump.rdb</span></span><br><span class="line">dbfilename redis.rdb</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"><span class="comment"># 本地数据库的目录,默认是 ./</span></span><br><span class="line">dir /var/lib/redis</span><br><span class="line"><span class="comment"># AOF 重写</span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename redis.aof</span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># 配置连接密码</span></span><br><span class="line">requirepass menglu</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 systemd 启动服务</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/redis.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis persistent key-value database</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/redis-server /etc/redis.conf --supervised systemd</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/bin/redis-cli -p 6379 shutdown</span><br><span class="line">Type=notify</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务并设置为开机自启</span></span><br><span class="line">systemctl start redis &amp;&amp; systemctl <span class="built_in">enable</span> redis</span><br></pre></td></tr></table></figure>



<h1 id="Redis-基础命令"><a href="#Redis-基础命令" class="headerlink" title="Redis 基础命令"></a>Redis 基础命令</h1><p>1.<strong>DBSIZE</strong> 查看 <code>key</code> 的数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dbsize</span><br></pre></td></tr></table></figure>

<p>2.<strong>慎用 KEYS</strong> 查看所有的 <code>key</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>

<p>3.<strong>EXISTS</strong> 查看给定的 <code>key</code> 是否存在</p>
<p>返回值 <code>n</code> 表示有的 <code>n</code> 个 <code>key</code> 存在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exists alan</span><br><span class="line">exists alan yuiya</span><br></pre></td></tr></table></figure>

<p>4.<strong>DEL</strong> 删除一个或多个 <code>key</code></p>
<p>返回值 <code>n</code> 表示成功删除了 <code>n</code> 个 <code>key</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">del k1</span><br><span class="line">del k1 k2 k3</span><br></pre></td></tr></table></figure>

<p>5.<strong>EXPIRE</strong> 设置给定 <code>key</code> 的过期时间。</p>
<p>过期后将不再可用。单位为秒。设置成功返回 <code>1</code> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expire k1 100</span><br></pre></td></tr></table></figure>

<p>6.<strong>PERSIST</strong> 取消给定 <code>key</code> 过期时间。</p>
<p>取消成功返回 <code>1</code> 。如果 <code>key</code> 不存在或 <code>key</code> 没有设置过期时间则返回 <code>0</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">persist k1</span><br></pre></td></tr></table></figure>

<p>7.<strong>TTL</strong> 查看 <code>key</code> 的剩余过期时间。单位为秒。</p>
<p>返回值为 <code>-1</code> 时表示该 <code>key</code> 没有设置过期时间。</p>
<p>返回值为 <code>-2</code> 时表示该 <code>key</code> 不存在。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ttl k1</span><br></pre></td></tr></table></figure>

<br>

<h2 id="字符串-String"><a href="#字符串-String" class="headerlink" title="字符串 ( String )"></a>字符串 ( String )</h2><p>1.<strong>SET</strong> 设置一个 <code>key</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set k1 1</span><br></pre></td></tr></table></figure>

<p>2.<strong>MSET</strong> 设置多个 <code>key</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mset k1 1 k2 2</span><br></pre></td></tr></table></figure>

<p>3.<strong>GET</strong> 查看一个 <code>key</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get k1</span><br></pre></td></tr></table></figure>

<p>4.<strong>MGET</strong> 查看多个 <code>key</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mget k1 k2</span><br></pre></td></tr></table></figure>

<p>5.<strong>INCR</strong> 将 key 中的数值增加 <code>1</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incr k1</span><br></pre></td></tr></table></figure>

<p>6.<strong>INCRBY</strong> 将 <code>key</code> 中的数值增加 <code>n</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incrby k1 511</span><br></pre></td></tr></table></figure>

<p>7.<strong>DECR</strong> 将 <code>key</code> 中的数值减去 <code>1</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decr k1</span><br></pre></td></tr></table></figure>

<p>8.<strong>DECRBY</strong> 将 <code>key</code> 中的数值减去 <code>n</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decrby k1 511</span><br></pre></td></tr></table></figure>

<p>9.<strong>GETRANGE</strong> 获取 <code>key</code> 值的指定部分，字符串的截取范围由 <code>start</code> 和 <code>end</code> 两个偏移量决定 (包括 <code>start</code> 和 <code>end</code> )</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> a alan</span><br><span class="line">getrange a 0 2</span><br><span class="line"><span class="string">"ala"</span></span><br></pre></td></tr></table></figure>

<ol start="10">
<li><strong>SETRANGE</strong> 用指定的字符串，从指定的起始位置开始，覆盖给定 key 所储存的字符串值</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> a alan</span><br><span class="line">setrange a 0 ttt</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">get a</span><br><span class="line"><span class="string">"tttn"</span></span><br></pre></td></tr></table></figure>

<br>

<h2 id="列表-List"><a href="#列表-List" class="headerlink" title="列表 ( List )"></a>列表 ( List )</h2><p>1.<strong>LPUSH</strong> 从列表 左侧 插入数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lpush list a b</span><br></pre></td></tr></table></figure>

<p>2.<strong>RPUSH</strong> 从列表 右侧 依次插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpush list c d e f</span><br></pre></td></tr></table></figure>

<p>3.<strong>LLEN</strong> 查看列表长度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llen list</span><br></pre></td></tr></table></figure>

<p>4.<strong>LRANGE</strong> 查看列表中指定区间的元素</p>
<p>0 代表第一个元素, 1 代表第二个元素, 以此类推 ; -1 代表最后一个元素</p>
<p>查看列表中的所有元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lrange list 2 5</span><br></pre></td></tr></table></figure>

<p>查看从第 3 个元素开始到第 6 个元素之间的 4 个元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lrange list 0 -1</span><br></pre></td></tr></table></figure>

<p>5.<strong>LPOP</strong> 从列表 左边 删除一个元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lpop list</span><br></pre></td></tr></table></figure>

<p>6.<strong>RPOP</strong> 从列表 右边 删除一个元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpop list</span><br></pre></td></tr></table></figure>

<p>7.<strong>DEL</strong> 删除列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del list</span><br></pre></td></tr></table></figure>

<br>

<h2 id="哈希-Hash"><a href="#哈希-Hash" class="headerlink" title="哈希 ( Hash )"></a>哈希 ( Hash )</h2><p>例如 : 数据库中有一张表 <code>user</code> 包含 <code>id</code>, <code>name</code>, <code>age</code>, <code>sex</code> 四个属性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	id  name  age  sex</span><br><span class="line">1、	1  小明   16   1</span><br><span class="line">2、	2  小红   20   0</span><br><span class="line">3、	3  小军   18   1</span><br></pre></td></tr></table></figure>

<p>如果要整表缓存到 <code>redis</code> 中则使用 <code>hash</code>，一条数据一个 <code>hash</code>, 一个 <code>hash</code> 里则包含 <code>4</code> 个 <code>filed</code> 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      key     field1 value1  field2 value2  field3 value3 field value</span><br><span class="line">hmset user_1  id     1       name   小明    age    16     sex   1</span><br><span class="line">hmset user_2  id     2       name   小红    age    20     sex   0</span><br><span class="line">hmset user_3  id     3       name   小军    age    18     sex   1</span><br></pre></td></tr></table></figure>

<br>

<p>1.<strong>HSET</strong> 给哈希表 <code>key</code> 中的域 <code>field</code> 赋值</p>
<p>如果给定的哈希表并不存在， 那么一个新的哈希表将被创建并执行 <code>HSET</code> 操作。</p>
<p>如果域 <code>field</code> 已经存在于哈希表中， 那么它的旧值将被新值 <code>value</code> 覆盖 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hset myhash rocc linux.rocc.top</span><br></pre></td></tr></table></figure>

<p>当 <code>HSET</code> 命令在哈希表中新创建 <code>field</code> 域并成功为它设置值时， 命令返回 <code>1</code> ； 如果域 <code>field</code> 已经存在于哈希表， 并且 <code>HSET</code> 命令成功使用新值覆盖了它的旧值， 那么命令返回 <code>0</code> 。</p>
<p>2.<strong>HMSET</strong> 设置一个或多个域值对 <code>field-value</code> 到哈希表中。</p>
<p>如果哈希表不存在，会创建一个新的哈希表，并执行 <code>HMSET</code> 操作。</p>
<p>如果域 <code>field</code> 已经存在于哈希表中， 那么它的旧值将被新值 <code>value</code> 覆盖 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hmset myhash rocc rocc.top google google.com</span><br></pre></td></tr></table></figure>

<p>如果命令执行成功，返回 <code>OK</code> 。当 <code>key</code> 不是哈希表类型时，返回一个错误。</p>
<p>3.<strong>HMGET</strong> 返回哈希表 <code>key</code> 中，一个或多个给定域的值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hmget myhash rocc google</span><br></pre></td></tr></table></figure>

<p>如果给定的域不存在于哈希表，那么返回一个 <code>nil</code> 值。</p>
<p>对一个不存在的 <code>key</code> 进行 <code>HMGET</code> 操作会返回一个只带有 <code>nil</code> 值的表。</p>
<p>4.<strong>HGETALL</strong> 返回哈希表 <code>key</code> 中，所有的域和值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hgetall myhash</span><br></pre></td></tr></table></figure>

<br>

<h2 id="集合-Set"><a href="#集合-Set" class="headerlink" title="集合 ( Set )"></a>集合 ( Set )</h2><p>  集合中不会出现重复的值，自动去重。</p>
<p>1.<strong>SADD</strong> 添加一个或多个 <code>member</code> 元素到集合 <code>key</code> 当中，已经存在于集合的 <code>member</code> 元素将被忽略。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sadd set1 1 2 3</span><br><span class="line">sadd set2 1 3 5 7</span><br></pre></td></tr></table></figure>

<p>​    当 <code>key</code> 不存在时，则会先创建再添加元素。</p>
<p>2.<strong>SMEMBERS</strong> 返回集合 <code>key</code> 中的所有成员。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smembers set1</span><br><span class="line">smembers set2</span><br></pre></td></tr></table></figure>

<p>3.<strong>SINTER</strong> 查看集合的交集。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sinter set1 set2</span><br></pre></td></tr></table></figure>

<p>4.<strong>SUNION</strong> 查看集合的并集。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sunion set1 set2</span><br></pre></td></tr></table></figure>

<p>5.<strong>SDIFF</strong> 查看集合的差集。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sdiff set1 set2</span><br></pre></td></tr></table></figure>

<p>6.<strong>SCARD</strong> 查看一个集合中的元素数量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scard set1</span><br></pre></td></tr></table></figure>

<p>7.<strong>SREM</strong> 删除一个或多个成员。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">srem set1 1 2</span><br></pre></td></tr></table></figure>

<br>

<h2 id="有序集合-zset"><a href="#有序集合-zset" class="headerlink" title="有序集合 ( zset )"></a>有序集合 ( zset )</h2><p>1.<strong>ZADD</strong> 添加一个或多个 <code>member</code> 元素及其 <code>score</code> 值到有序集合 <code>key</code> 中。</p>
<p>如果某个 <code>member</code> 已经是有序集的成员，那么更新这个 <code>member</code> 的 <code>score</code> 值，并通过重新插入这个 <code>member</code> 元素，来保证该 <code>member</code> 在正确的位置上。<code>score</code> 值可以是整数值或双精度浮点数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zadd sz 99 alan 100 yuiya</span><br></pre></td></tr></table></figure>

<p>2.<strong>ZSCORE</strong> 查看某个成员的 <code>score</code> 值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zscore sz alan</span><br><span class="line">zscore sz yuiya</span><br></pre></td></tr></table></figure>

<p>3.<strong>ZCARD</strong> 查看一个有序集合中元素的数量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zcard sz</span><br></pre></td></tr></table></figure>

<p>4.<strong>ZCOUNT</strong> 查看有序集合中，<code>score</code> 值在 <code>min</code> 和 <code>max</code> 之间 (默认包括<code>min</code> 和 <code>max</code>) 的成员的数量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zcount sz 99 100</span><br></pre></td></tr></table></figure>

<p>5.<strong>ZRANGE</strong> 查看有序集合中，指定区间内的成员。</p>
<p>成员的位置按 <code>score</code> 值递增 (从小到大) 来排序。</p>
<p>具有相同 <code>score</code> 值的成员按字典序来排列。</p>
<p>以 <code>0</code> 表示有序集第一个成员，以 <code>1</code> 表示有序集第二个成员，以此类推。 </p>
<p>负数下标，以 <code>-1</code> 表示最后一个成员，<code>-2</code> 表示倒数第二个成员，以此类推。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrange sz 0 -1</span><br></pre></td></tr></table></figure>

<p>6.<strong>ZRANGEBYSCORE</strong> 查看有序集合中，所有 <code>score</code> 值介于 <code>min</code> 和 <code>max</code> 之间 (包括<code>min</code> 和 <code>max</code>) 的成员。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrangebyscore sz 100 100</span><br></pre></td></tr></table></figure>

<p>7.<strong>ZREVRANGE</strong> 查看有序集合中，指定区间内的成员。</p>
<p>成员的位置按 <code>score</code> 值递减 (从大到小) 来排序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrevrange sz 0 -1</span><br></pre></td></tr></table></figure>

<p>8.<strong>ZRANK</strong> 查看有序集合中某个成员 <code>member</code> 的排名。</p>
<p>其中有序集成员按 <code>score</code> 值递增 (从小到大) 顺序排列。</p>
<p><code>score</code> 值最小的成员排名为 <code>0</code> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrank sz alan</span><br></pre></td></tr></table></figure>

<p>9.<strong>ZREVRANK</strong> 查看有序集合中某个成员 <code>member</code> 的排名。</p>
<p>其中有序集成员按 <code>score</code> 值递减 (从大到小) 顺序排列。</p>
<p><code>score</code> 值最大的成员排名为 <code>0</code> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrevrank sz yuiya</span><br></pre></td></tr></table></figure>

<p>10.<strong>ZINCRBY</strong> 为有序集合中的成员 <code>member</code> 的 <code>score</code> 值加上增量 <code>increment</code> 。</p>
<p>可以通过传递一个负数值 <code>increment</code> ，让 <code>score</code> 减去相应的值。</p>
<p>当 <code>key</code> 不存在，或 <code>member</code> 不是 <code>key</code> 的成员时， <code>ZINCRBY key increment member</code> 等同于 <code>ZADD key increment member</code> 。</p>
<p><code>score</code> 和 <code>increment</code> 的值可以是整数值或双精度浮点数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zincrby sz 1 alan</span><br></pre></td></tr></table></figure>

<p>11.<strong>ZREM</strong> 删除有序集合中的一个或多个成员。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zrem sz alan</span><br></pre></td></tr></table></figure>

<br>

<h1 id="Redis-用户认证"><a href="#Redis-用户认证" class="headerlink" title="Redis 用户认证"></a>Redis 用户认证</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 1.在配置文件中设置密码</span><br><span class="line">requirepass linux</span><br><span class="line"></span><br><span class="line"># 2.使用密码登陆的两种方式：</span><br><span class="line"># 方式一</span><br><span class="line">redis-cli </span><br><span class="line">auth linux</span><br><span class="line">set k1 v1</span><br><span class="line"># 方式二</span><br><span class="line">redis-cli -a linux get k1</span><br><span class="line"></span><br><span class="line"># 禁用或重命名危险命令</span><br><span class="line">rename-command CONFIG &quot;&quot;</span><br><span class="line">rename-command KEYS &quot;&quot;</span><br><span class="line">rename-command SHUTDOWN &quot;&quot;</span><br><span class="line">rename-command FLUSHALL &quot;&quot;</span><br><span class="line">rename-command DEL &quot;&quot;</span><br><span class="line">rename-command FLUSHDB &quot;&quot;</span><br></pre></td></tr></table></figure>



<h1 id="Redis-持久化"><a href="#Redis-持久化" class="headerlink" title="Redis 持久化"></a>Redis 持久化</h1><p>持久化是最简单的高可用方法。它的主要作用是 <strong>数据备份</strong>，即将数据存储在 <strong>磁盘</strong>，保证数据不会因进程退出而丢失。Redis 为持久化提供了 RDB 和 AOF 两种方式。</p>
<p>Redis 内部存在一个定时任务机制，定时任务执行的频率可以在配置文件中通过 hz 10 来设置（这个配置表示 1s 内执行 10 次，即每 100ms 触发一次定时任务）。该值最大能够设置为：500，但是不建议超过：100，因为值越大说明执行频率越频繁越高，这会带来 CPU 的更多消耗，从而影响主进程读写性能。</p>
<p>定时任务使用的是 Redis 自己实现的 <strong>TimeEvent</strong>，它会定时去调用一些命令完成定时任务，这些任务可能会阻塞主进程导致 Redis 性能下降。因此我们在配置 Redis 时，一定要整体考虑一些会触发定时任务的配置，根据实际情况进行调整。</p>
<br>

<h2 id="RDB-方式持久化"><a href="#RDB-方式持久化" class="headerlink" title="RDB  方式持久化"></a>RDB  方式持久化</h2><p><strong>RDB</strong>：在指定的时间间隔对数据进行快照存储。</p>
<p>优点：文件简洁，恢复速度快，适合做备份。</p>
<p>缺点：实时性差，容易造成数据的丢失。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RDB 文件名，默认为 dump.rdb</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件存放的目录，AOF 文件同样存放在此目录。默认为当前工作目录</span></span><br><span class="line">dir ./</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定在每 N 秒后数据发生了 M 次改变就保存快照文件</span></span><br><span class="line">save 900 1		<span class="comment"># 900 秒内如果有 1 条是写入命令，就触发产生一次快照</span></span><br><span class="line">save 300 10 	<span class="comment"># 300 秒内如果有 10 条是写入命令，就触发产生一次快照</span></span><br><span class="line">save 60 10000 	<span class="comment"># 60  秒内如果有 10000 条是写入命令，就触发产生一次快照</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认 Redis 会采用 LZF 对数据进行压缩。如果你想节省点 CPU 的性能，就可以把压缩功能禁用掉，但是数据集就会比没压缩时大</span></span><br><span class="line">rdbcompression yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果持久化出错，主进程是否停止写入</span></span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入时是否检查，从版本 5.0 的 RDB 开始，一个 CRC64 的校验码会放在文件的末尾。这样更能保证文件的完整性，但是在保存或者加载文件时会损失一定的性能（大概10%）。如果想追求更高的性能，可以把它禁用掉，这样文件在写入校验码时会用 0 替代，加载的时候看到 0 就会直接跳过校验。</span></span><br><span class="line">rdbchecksum yes</span><br></pre></td></tr></table></figure>

<br>

<p>在 Redis 中 RDB 持久化的触发分为两种：自己手动触发与 Redis 定时触发。</p>
<p><strong>针对 RDB 方式的持久化，手动触发可以使用：</strong></p>
<ul>
<li>save：会阻塞当前 Redis 服务器，直到持久化完成，线上应该禁止使用。</li>
<li>bgsave：该触发方式会 <code>fork</code> 一个子进程，由子进程负责持久化过程，因此阻塞只会发生在 <code>fork</code> 子进程的时候。</li>
</ul>
<p><strong>自动触发的场景主要是有以下几点：</strong></p>
<ul>
<li>根据 <code>save m n</code> 配置规则自动触发；</li>
<li>从节点全量复制时，主节点发送 <code>rdb</code> 文件给从节点完成复制操作，主节点会触发 <code>bgsave</code>；</li>
<li>执行 <code>debug reload</code> 时；</li>
<li>执行 <code>shutdown</code>,<code>kill</code>,<code>pkill</code> 时都会自动触发 <code>bgsave</code>。</li>
</ul>
<p>需要注意的是 <code>fork</code> 操作会阻塞，导致 Redis 读写性能下降。我们可以控制单个 Redis 实例的最大内存，来尽可能降低Redis 在 <code>fork</code> 时的事件消耗。也可以通过控制自动触发的频率减少 <code>fork</code> 次数，或者使用手动触发，根据自己的机制来完成持久化。</p>
<br>

<br>

<h2 id="AOF-方式持久化"><a href="#AOF-方式持久化" class="headerlink" title="AOF  方式持久化"></a>AOF  方式持久化</h2><p><strong>AOF</strong>：以追加的方式记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据。</p>
<p>优点：安全，在默认配置下最多损失 1 秒的数据，aof 文件简单易读。</p>
<p>缺点：文件较大，恢复速度慢。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 是否启用 AOF</span></span><br><span class="line">appendonly yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># aof 文件存放目录，与 rdb 共用。默认为当前工作目录</span></span><br><span class="line">dir ./</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认文件名为 appendonly.aof</span></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步方式 (调用 fsync)</span></span><br><span class="line"><span class="comment"># fsync 函数只对由文件描述符 filedes 指定的单一文件起作用，并且等待写磁盘操作结束，然后返回。fsync 可用于数据库这样的应用程序，这种应用程序需要确保将修改过的块立即写到磁盘上。</span></span><br><span class="line"><span class="comment"># appendfsync no	    # 从不调用 fsync，交给 OS 来处理，非常快但最不安全</span></span><br><span class="line"><span class="comment"># appendfsync always 	# 每当有新命令时立即写入到 AOF </span></span><br><span class="line">appendfsync everysec 	<span class="comment"># 每秒同步(fsync)一次，默认推荐方式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果启用 aof-load-truncated，在加载时发现 aof 尾部不正确时，会向客户端写入一个 log，但是会继续执行，如果设置为 no ，发现错误就会停止，必须修复后才能重新加载</span></span><br><span class="line">aof-load-truncated yes</span><br></pre></td></tr></table></figure>

<br>

<p>AOF 的整个流程大体来看可以分为两步，一步是命令的实时写入（如果是 <code>appendfsync everysec</code> 配置，会有 1s 损耗），第二步是对 aof 文件的重写。</p>
<p>对于实时写入这一步主要的流程是：命令写入 ==&gt; 追加到 aof_buf ==&gt; 同步到 aof 磁盘。那么这里为什么要先写入 buf 在同步到磁盘呢？如果实时写入磁盘会带来非常高的磁盘 IO，影响整体性能。</p>
<p>aof 重写是为了减少 aof 文件的大小，可以手动或者自动触发。<code>fork</code> 的操作也是发生在重写这一步，这里也会对主进程产生阻塞。</p>
<p><strong>手动触发：</strong> <code>bgrewriteaof</code>，<strong>自动触发</strong> 就是根据配置规则来触发，当然自动触发的整体时间还跟 Redis 的定时任务频率有关系。</p>
<ol>
<li>在重写期间，由于主进程依然在响应命令，为了保证最终备份的完整性；因此它依然会写入旧的 AOF file 中，如果重写失败，能够保证数据不丢失。</li>
<li>为了把重写期间响应的写入信息也写入到新的文件中，因此也会为子进程保留一个 buf，防止新写的 file 丢失数据。</li>
<li>重写是直接把当前内存的数据生成对应命令，并不需要读取旧的 AOF 文件进行分析、命令合并。</li>
<li>AOF 文件直接采用的文本协议，主要是兼容性好、追加方便、可读性高可认为修改修复。</li>
</ol>
<blockquote>
<p>无论是 RDB 还是 AOF 都是先写入一个临时文件，然后通过 <code>rename</code> 完成文件的替换工作。</p>
</blockquote>
<br>

<h2 id="性能与实践"><a href="#性能与实践" class="headerlink" title="性能与实践"></a>性能与实践</h2><p>RDB 的快照和 AOF 的重写都需要 fork，这是一个重量级操作，会对 Redis 造成阻塞。因此为了不影响 Redis 主进程响应，我们需要尽可能降低阻塞。</p>
<ol>
<li>降低 fork 的频率，比如可以手动来触发 RDB 生成快照、与 AOF 重写；</li>
<li>控制 Redis 最大使用内存，防止 fork 耗时过长；</li>
<li>使用更高配置的硬件；</li>
<li>合理配置 Linux 的内存分配策略，避免因为物理内存不足导致 fork 失败。</li>
</ol>
<p>在线上我们到底该怎么做？</p>
<ol>
<li>如果 Redis 中的数据并不是特别敏感或者可以通过其它方式重写生成数据，可以关闭持久化，如果丢失数据可以通过其它途径补回；</li>
<li>自己制定策略定期检查 Redis 的情况，然后可以手动触发备份、重写数据；</li>
<li>单机如果部署多个实例，要防止多个实例同时运行持久化、重写操作，防止出现内存、CPU、IO 资源竞争，让持久化变为串行；</li>
<li>可以加入主从机器，利用一台从机器进行备份处理，其它机器正常响应客户端的命令；</li>
<li>RDB 持久化与 AOF 持久化可以同时存在，配合使用。</li>
</ol>
<h1 id="Redis-主从复制"><a href="#Redis-主从复制" class="headerlink" title="Redis 主从复制"></a>Redis 主从复制</h1><p>复制是高可用 <code>Redis</code> 的基础，<strong>哨兵</strong> 和 <strong>集群</strong> 都是在 <strong>复制基础</strong> 上实现高可用的。复制主要实现了数据的多机备份以及对于读操作的负载均衡和简单的故障恢复。缺陷是故障恢复无法自动化、写操作无法负载均衡、存储能力受到单机的限制。</p>
<br>

<h2 id="配置主从坏境"><a href="#配置主从坏境" class="headerlink" title="配置主从坏境"></a>配置主从坏境</h2><table>
<thead>
<tr>
<th>主机名</th>
<th align="left">角色</th>
<th align="left">IP 地址</th>
<th align="left">端口号</th>
</tr>
</thead>
<tbody><tr>
<td>db01</td>
<td align="left">Master</td>
<td align="left">10.0.0.3</td>
<td align="left">6379</td>
</tr>
<tr>
<td>db02</td>
<td align="left">Slave-01</td>
<td align="left">10.0.1.3</td>
<td align="left">6379</td>
</tr>
<tr>
<td>db03</td>
<td align="left">Slave-02</td>
<td align="left">10.0.2.3</td>
<td align="left">6379</td>
</tr>
</tbody></table>
<br>

<h3 id="Master-主服务器-db01-配置"><a href="#Master-主服务器-db01-配置" class="headerlink" title="Master 主服务器 db01 配置"></a>Master 主服务器 db01 配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/redis.conf &lt;&lt; EOF</span><br><span class="line">daemonize yes</span><br><span class="line"><span class="built_in">bind</span> 10.0.0.3 127.0.0.1</span><br><span class="line">port 6379</span><br><span class="line">pidfile /var/run/redis/redis.pid</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis.log</span><br><span class="line">databases 16</span><br><span class="line">dbfilename redis.rdb</span><br><span class="line">dir /var/lib/redis</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename redis.aof</span><br><span class="line">appendfsync everysec</span><br><span class="line">masterauth menglu</span><br><span class="line">requirepass menglu</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart redis</span><br></pre></td></tr></table></figure>

<br>

<h3 id="Slave-01-从服务器-db02-配置"><a href="#Slave-01-从服务器-db02-配置" class="headerlink" title="Slave-01 从服务器 db02 配置"></a>Slave-01 从服务器 db02 配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/redis.conf &lt;&lt; EOF</span><br><span class="line">daemonize yes</span><br><span class="line"><span class="built_in">bind</span> 10.0.1.3 127.0.0.1</span><br><span class="line">port 6379</span><br><span class="line">pidfile /var/run/redis/redis.pid</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis.log</span><br><span class="line">databases 16</span><br><span class="line">dbfilename redis.rdb</span><br><span class="line">dir /var/lib/redis</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename redis.aof</span><br><span class="line">appendfsync everysec</span><br><span class="line">masterauth menglu</span><br><span class="line">requirepass menglu</span><br><span class="line">slaveof 10.0.0.3 6379</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart redis</span><br></pre></td></tr></table></figure>

<br>

<h3 id="Slave-02-从服务器-db03-配置"><a href="#Slave-02-从服务器-db03-配置" class="headerlink" title="Slave-02 从服务器 db03 配置"></a>Slave-02 从服务器 db03 配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/redis.conf &lt;&lt; EOF</span><br><span class="line">daemonize yes</span><br><span class="line"><span class="built_in">bind</span> 10.0.2.3 127.0.0.1</span><br><span class="line">port 6379</span><br><span class="line">pidfile /var/run/redis/redis.pid</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis.log</span><br><span class="line">databases 16</span><br><span class="line">dbfilename redis.rdb</span><br><span class="line">dir /var/lib/redis</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename redis.aof</span><br><span class="line">appendfsync everysec</span><br><span class="line">masterauth menglu</span><br><span class="line">requirepass menglu</span><br><span class="line">slaveof 10.0.0.3 6379</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart redis</span><br></pre></td></tr></table></figure>

<br>

<p><strong>临时开启复制</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.0.1.3 slaveof 10.0.0.3 6379</span><br><span class="line">redis-cli -h 10.0.2.3 slaveof 10.0.0.3 6379</span><br></pre></td></tr></table></figure>

<p>*<em>临时取消复制 *</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 10.0.1.3  slaveof no one</span><br><span class="line">redis-cli -h 10.0.2.3  slaveof no one</span><br></pre></td></tr></table></figure>

<br>

<h2 id="主从复制流程"><a href="#主从复制流程" class="headerlink" title="主从复制流程"></a>主从复制流程</h2><ol>
<li>从节点发送同步请求到主节点。</li>
<li>主节点接收到从节点的请求之后,立即执行 bgsave 将当前内存里的数据持久化到磁盘上,完成之后,将 rdb 文件发送给从节点。</li>
<li>从节点从主节点接收到 rdb 文件后,清空自己的数据,载入从主节点接收的 rdb 文件到自己的内存里。</li>
<li>从节点与和主节点实时同步。</li>
</ol>
<h1 id="Redis-sentinel-哨兵模式"><a href="#Redis-sentinel-哨兵模式" class="headerlink" title="Redis sentinel 哨兵模式"></a>Redis sentinel 哨兵模式</h1><p>哨兵在主从复制的基础上，实现了 <strong>自动化</strong> 的 <strong>故障恢复</strong>。缺陷是 <strong>写操作</strong> 无法 <strong>负载均衡</strong>，<strong>存储能力</strong> 受到 <strong>单机</strong> 的限制。</p>
<br>

<p><img src="https://download.rocc.top/img/image-20200311103320214.png" alt></p>
<br>

<table>
<thead>
<tr>
<th>主机名</th>
<th align="left">角色</th>
<th align="left">IP 地址</th>
<th align="left">端口号</th>
</tr>
</thead>
<tbody><tr>
<td>db01</td>
<td align="left">Master，Sentinel</td>
<td align="left">10.0.0.3</td>
<td align="left">6379，26379</td>
</tr>
<tr>
<td>db02</td>
<td align="left">Slave，Sentinel</td>
<td align="left">10.0.1.3</td>
<td align="left">6379，26379</td>
</tr>
<tr>
<td>db03</td>
<td align="left">Slave，Sentinel</td>
<td align="left">10.0.2.3</td>
<td align="left">6379，26379</td>
</tr>
</tbody></table>
<br>

<h2 id="Redis-Sentinel-搭建"><a href="#Redis-Sentinel-搭建" class="headerlink" title="Redis Sentinel 搭建"></a>Redis Sentinel 搭建</h2><p><strong>前提 : 主从复制已配置完成</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在三个节点上各执行一次</span></span><br><span class="line">cat &gt; /etc/redis-sentinel.conf &lt;&lt; EOF</span><br><span class="line"><span class="built_in">bind</span> $(ifconfig eth0 | awk <span class="string">'NR==2&#123;print $2&#125;'</span>)</span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis-sentinel.log</span><br><span class="line">dir /var/lib/redis</span><br><span class="line">sentinel monitor myredis 10.0.0.3 6379 2</span><br><span class="line">sentinel down-after-milliseconds myredis 3000</span><br><span class="line">sentinel parallel-syncs myredis 1</span><br><span class="line">sentinel failover-timeout myredis 18000</span><br><span class="line">sentinel auth-pass myredis menglu</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chown -R redis: /etc/redis*</span><br><span class="line"></span><br><span class="line">cat &gt; /usr/lib/systemd/system/redis-sentinel.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis Sentinel</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/redis-sentinel /etc/redis-sentinel.conf --supervised systemd</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/bin/redis-cli -h  $(ifconfig eth0|awk <span class="string">'NR==2&#123;print $2&#125;'</span>) -p 26379 shutdown</span><br><span class="line">Type=notify</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl start redis-sentinel &amp;&amp; systemctl <span class="built_in">enable</span> redis-sentinel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查各节点上的 master 地址是否一致</span></span><br><span class="line">redis-cli -h 10.0.0.3 -p 26379 Sentinel get-master-addr-by-name myredis</span><br><span class="line">redis-cli -h 10.0.1.3 -p 26379 Sentinel get-master-addr-by-name myredis</span><br><span class="line">redis-cli -h 10.0.2.3 -p 26379 Sentinel get-master-addr-by-name myredis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在该配置下实现故障自动转移前提: sentinel 最多能宕掉 1 个, redis 节点最多可以宕掉 2 个。</span></span><br></pre></td></tr></table></figure>

<br>

<h2 id="Redis-Sentinel-的主要功能"><a href="#Redis-Sentinel-的主要功能" class="headerlink" title="Redis Sentinel 的主要功能"></a>Redis Sentinel 的主要功能</h2><p><code>Sentinel</code> 的主要功能包括 <strong>主节点存活检测</strong>、<strong>主从运行情况检测</strong>、<strong>自动故障转移</strong>（<code>failover</code>）、<strong>主从切换</strong>。<code>Redis</code> 的 <code>Sentinel</code> 最小配置是 <strong>一主一从</strong>。</p>
<p><code>Redis</code> 的 <code>Sentinel</code> 系统可以用来管理多个 <code>Redis</code> 服务器，该系统可以执行以下四个任务：</p>
<ul>
<li><strong>监控</strong></li>
</ul>
<p><code>Sentinel</code> 会不断的检查 <strong>主节点</strong> 和 <strong>从节点</strong> 是否正常运行。</p>
<ul>
<li><strong>通知</strong></li>
</ul>
<p>当被监控的某个 <code>Redis</code> 节点出现问题，<code>Sentinel</code> 通过 <code>API</code> <strong>脚本</strong> 向 <strong>管理员</strong> 或者其他的 <strong>应用程序</strong> 发送通知。</p>
<ul>
<li><strong>自动故障转移</strong></li>
</ul>
<p>当 <strong>主节点</strong> 不能正常工作时，<code>Sentinel</code> 会开始一次 <strong>自动的</strong> 故障转移操作，它会将与 <strong>失效主节点</strong> 是 <strong>主从关系</strong> 的其中一个 <strong>从节点</strong> 升级为新的 <strong>主节点</strong>，并且将其他的 <strong>从节点</strong> 指向 <strong>新的主节点</strong>。</p>
<ul>
<li><strong>配置提供者</strong></li>
</ul>
<p>在 <code>Redis Sentinel</code> 模式下，<strong>客户端应用</strong> 在初始化时连接的是 <code>Sentinel</code> <strong>节点集合</strong>，从中获取 <strong>主节点</strong> 的信息。</p>
<br>

<p>给 redis 节点加权，来确定优先备选主节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">流程说明：</span><br><span class="line">设置其他节点的权重为 0</span><br><span class="line">手动发起重新选举</span><br><span class="line">观察所有节点消息是否同步</span><br><span class="line">观察切换结果是否符合预期</span><br><span class="line"></span><br><span class="line">命令解释：</span><br><span class="line">查询命令:CONFIG GET slave-priority</span><br><span class="line">设置命令:CONFIG SET slave-priority 0</span><br><span class="line">主动切换:sentinel failover myredis</span><br><span class="line"></span><br><span class="line">操作命令：</span><br><span class="line">redis-cli -h 10.0.0.3 -p 6379 CONFIG SET slave-priority 0</span><br><span class="line">redis-cli -h 10.0.1.3 -p 6379 CONFIG SET slave-priority 0</span><br><span class="line">redis-cli -h 10.0.2.3 -p 26379 sentinel failover myredis</span><br><span class="line"></span><br><span class="line">验证选举结果：</span><br><span class="line">redis-cli -h 10.0.0.3 -p 26379 Sentinel get-master-addr-by-name myredis</span><br></pre></td></tr></table></figure>



<h1 id="Redis-集群"><a href="#Redis-集群" class="headerlink" title="Redis 集群"></a>Redis 集群</h1><br>

<p>通过集群，<code>Redis</code> 可以解决 写操作无法 <strong>负载均衡</strong> 以及 <strong>存储能力</strong> 受到 <strong>单机限制</strong> 的问题，实现了较为 完善 的 高可用方案。<code>Redis Cluster</code> 集群模式通常具有 <strong>高可用</strong>、<strong>可扩展性</strong>、<strong>分布式</strong>、<strong>容错</strong> 等特性。</p>
<br>

<h2 id="集群的基本概念"><a href="#集群的基本概念" class="headerlink" title="集群的基本概念"></a><strong>集群的基本概念</strong></h2><p>redis 集群，无论有几个节点，一共只有16384个槽。</p>
<p>所有的槽位都必须分配，哪怕有 <code>1</code> 个槽位不正常，整个集群都无法不用。</p>
<p>每个节点的槽的顺序不重要，重点是数量。</p>
<p>hash 算法足够随机，足够平均。</p>
<p>每个槽被分配到数据的概率是相当的。</p>
<p>集群的高可用依赖于主从复制。</p>
<p>集群拥有自己的配置文件，动态更新，不要手动修改。</p>
<p>集群通讯会使用基础端口号 +10000 的端口，这个是自动创建的，不是配置文件配置的。</p>
<p>集群槽位分配比例允许误差在 2% 之间。</p>
<br>

<table>
<thead>
<tr>
<th>实例名</th>
<th align="left">IP 地址</th>
<th align="left">端口号</th>
</tr>
</thead>
<tbody><tr>
<td>db01-redis-6380</td>
<td align="left">10.0.0.3</td>
<td align="left">6380，16380</td>
</tr>
<tr>
<td>db01-redis-6381</td>
<td align="left">10.0.0.3</td>
<td align="left">6381，16381</td>
</tr>
<tr>
<td>db02-redis-6380</td>
<td align="left">10.0.1.3</td>
<td align="left">6380，16380</td>
</tr>
<tr>
<td>db02-redis-6381</td>
<td align="left">10.0.1.3</td>
<td align="left">6381，16381</td>
</tr>
<tr>
<td>db03-redis-6380</td>
<td align="left">10.0.2.3</td>
<td align="left">6380，16380</td>
</tr>
<tr>
<td>db03-redis-6381</td>
<td align="left">10.0.2.3</td>
<td align="left">6381，26381</td>
</tr>
<tr>
<td>db01-redis-6390</td>
<td align="left">10.0.0.3</td>
<td align="left">6390，16390</td>
</tr>
<tr>
<td>db01-redis-6391</td>
<td align="left">10.0.0.3</td>
<td align="left">6391，16391</td>
</tr>
</tbody></table>
<br>

<h2 id="部署集群"><a href="#部署集群" class="headerlink" title="部署集群"></a>部署集群</h2><h3 id="在每台主机-db01、db02、db03-上配置两个实例"><a href="#在每台主机-db01、db02、db03-上配置两个实例" class="headerlink" title="在每台主机(db01、db02、db03)上配置两个实例"></a>在每台主机(db01、db02、db03)上配置两个实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署 redis-6380</span></span><br><span class="line">cat &gt; /etc/redis-6380.conf &lt;&lt; EOF</span><br><span class="line"><span class="comment"># 以守护进程模式启动</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="comment">#绑定的主机地址</span></span><br><span class="line"><span class="built_in">bind</span> `ifconfig eth0 | awk <span class="string">'NR==2&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="comment"># 监听端口</span></span><br><span class="line">port 6380</span><br><span class="line"><span class="comment"># pid 文件和 log 文件地址</span></span><br><span class="line">pidfile /var/run/redis/redis-6380.pid</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis-6380.log</span><br><span class="line"><span class="comment"># 设置数据库的数量，默认数据库为 0</span></span><br><span class="line">databases 16</span><br><span class="line"><span class="comment"># 指定本地持久化文件的文件名,默认是 dump.rdb</span></span><br><span class="line">dbfilename redis-6380.rdb</span><br><span class="line"><span class="comment"># 本地数据库的目录,默认是 ./</span></span><br><span class="line">dir /var/lib/redis</span><br><span class="line"><span class="comment"># AOF 重写</span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename redis-6380.aof</span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># 开启集群</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file cluster-6380.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis -p</span><br><span class="line">chown -R redis: /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis /etc/redis*</span><br><span class="line"></span><br><span class="line">cat &gt; /usr/lib/systemd/system/redis-6380.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis 6380</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/redis-server /etc/redis-6380.conf --supervised systemd</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/bin/redis-cli -h `ifconfig eth0 | awk <span class="string">'NR==2&#123;print $2&#125;'</span>` -p 6380 shutdown</span><br><span class="line">Type=notify</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl start redis-6380 &amp;&amp; systemctl <span class="built_in">enable</span> redis-6380</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 redis-6381</span></span><br><span class="line">cat &gt; /etc/redis-6381.conf &lt;&lt; EOF</span><br><span class="line"><span class="comment"># 以守护进程模式启动</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="comment">#绑定的主机地址</span></span><br><span class="line"><span class="built_in">bind</span> `ifconfig eth0 | awk <span class="string">'NR==2&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="comment"># 监听端口</span></span><br><span class="line">port 6381</span><br><span class="line"><span class="comment"># pid 文件和 log 文件地址</span></span><br><span class="line">pidfile /var/run/redis/redis-6381.pid</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis-6381.log</span><br><span class="line"><span class="comment"># 设置数据库的数量，默认数据库为 0</span></span><br><span class="line">databases 16</span><br><span class="line"><span class="comment"># 指定本地持久化文件的文件名,默认是 dump.rdb</span></span><br><span class="line">dbfilename redis-6381.rdb</span><br><span class="line"><span class="comment"># 本地数据库的目录,默认是 ./</span></span><br><span class="line">dir /var/lib/redis</span><br><span class="line"><span class="comment"># AOF 重写</span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename redis-6381.aof</span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># 开启集群</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file cluster-6381.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis -p</span><br><span class="line">chown -R redis: /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis /etc/redis*</span><br><span class="line"></span><br><span class="line">cat &gt; /usr/lib/systemd/system/redis-6381.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis 6381</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/redis-server /etc/redis-6381.conf --supervised systemd</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/bin/redis-cli -h `ifconfig eth0 | awk <span class="string">'NR==2&#123;print $2&#125;'</span>` -p 6381 shutdown</span><br><span class="line">Type=notify</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl start redis-6381 &amp;&amp; systemctl <span class="built_in">enable</span> redis-6381</span><br></pre></td></tr></table></figure>

<br>

<h3 id="手动配置集群"><a href="#手动配置集群" class="headerlink" title="手动配置集群"></a>手动配置集群</h3><h4 id="1-集群各节点互相发现"><a href="#1-集群各节点互相发现" class="headerlink" title="1.集群各节点互相发现"></a>1.集群各节点互相发现</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在一个节点上将各节点加入集群</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster meet 10.0.0.5 6381</span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster meet 10.0.0.6 6380</span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster meet 10.0.0.6 6381</span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster meet 10.0.0.7 6380</span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster meet 10.0.0.7 6381</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看各节点是否配置成功</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster nodes</span><br></pre></td></tr></table></figure>

<br>

<h4 id="2-分配槽位"><a href="#2-分配槽位" class="headerlink" title="2.分配槽位"></a>2.分配槽位</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在三个节点平均分配 16384 个槽位</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster addslots &#123;0..5460&#125;</span><br><span class="line">redis-cli -h 10.0.0.6 -p 6380 cluster addslots &#123;5461..10921‬&#125;</span><br><span class="line">redis-cli -h 10.0.0.7 -p 6380 cluster addslots &#123;10922..16383&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群槽位信息</span></span><br><span class="line">redis-cli --cluster info 10.0.0.5 6380</span><br></pre></td></tr></table></figure>

<br>

<h4 id="3-配置复制关系"><a href="#3-配置复制关系" class="headerlink" title="3.配置复制关系"></a>3.配置复制关系</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群各节点的 ID</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster nodes | grep 6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 交叉配置复制关系 0:6381 = 1:6380 , 1:6381 = 2:6380 , 2:6381 = 0:6380</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6381 cluster replicate 32ff53a704b8b948a75378402205fe9aeec8bcfb</span><br><span class="line">redis-cli -h 10.0.0.6 -p 6381 cluster replicate e216a3fa79465a45cbdfedd125836ca7edb759b8</span><br><span class="line">redis-cli -h 10.0.0.7 -p 6381 cluster replicate e69b43cfc5f93aae9121e88fbf3467e6354df6fc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看复制关系</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster nodes</span><br></pre></td></tr></table></figure>

<br>

<h3 id="自动配置集群"><a href="#自动配置集群" class="headerlink" title="自动配置集群"></a>自动配置集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 10.0.0.5:6380 10.0.0.6:6380 10.0.0.7:6380 10.0.0.5:6381 10.0.0.6:6381 10.0.0.7:6381 --cluster-replicas 1</span><br><span class="line">yes</span><br><span class="line"><span class="comment"># 检查集群各节点</span></span><br><span class="line">redis-cli -h 10.0.0.7 -p 6380 cluster nodes</span><br></pre></td></tr></table></figure>

<br>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证集群的写入数据分配是否平衡</span></span><br><span class="line"><span class="comment"># 写入测试数据</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10000&#125;; <span class="keyword">do</span> redis-cli -c -h 10.0.0.5 -p 6380 <span class="built_in">set</span> k<span class="variable">$&#123;i&#125;</span> v<span class="variable">$&#123;i&#125;</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看各节点 key 的数量</span></span><br><span class="line">redis-cli --cluster info 10.0.0.5 6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行集群检查</span></span><br><span class="line">redis-cli --cluster rebalance 10.0.0.5 6380</span><br></pre></td></tr></table></figure>

<br>

<br>

<h2 id="集群扩容和收缩"><a href="#集群扩容和收缩" class="headerlink" title="集群扩容和收缩"></a>集群扩容和收缩</h2><h3 id="增配-2-个实例"><a href="#增配-2-个实例" class="headerlink" title="增配 2 个实例"></a>增配 2 个实例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/redis-6390.conf &lt;&lt; EOF</span><br><span class="line"><span class="comment"># 以守护进程模式启动</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="comment">#绑定的主机地址</span></span><br><span class="line"><span class="built_in">bind</span> `ifconfig eth0 | awk <span class="string">'NR==2&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="comment"># 监听端口</span></span><br><span class="line">port 6390</span><br><span class="line"><span class="comment"># pid 文件和 log 文件地址</span></span><br><span class="line">pidfile /var/run/redis/redis-6390.pid</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis-6390.log</span><br><span class="line"><span class="comment"># 设置数据库的数量，默认数据库为 0</span></span><br><span class="line">databases 16</span><br><span class="line"><span class="comment"># 指定本地持久化文件的文件名,默认是 dump.rdb</span></span><br><span class="line">dbfilename redis-6390.rdb</span><br><span class="line"><span class="comment"># 本地数据库的目录,默认是 ./</span></span><br><span class="line">dir /var/lib/redis</span><br><span class="line"><span class="comment"># AOF 重写</span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"redis-6390.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># 开启集群</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file cluster-6390.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis -p</span><br><span class="line">chown -R redis: /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis /etc/redis*</span><br><span class="line"></span><br><span class="line">cat &gt; /usr/lib/systemd/system/redis-6390.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis 6390</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/redis-server /etc/redis-6390.conf --supervised systemd</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/bin/redis-cli -h `ifconfig eth0 | awk <span class="string">'NR==2&#123;print $2&#125;'</span>` -p 6390 shutdown</span><br><span class="line">Type=notify</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl start redis-6390 &amp;&amp; systemctl <span class="built_in">enable</span> redis-6390</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/redis-6391.conf &lt;&lt; EOF</span><br><span class="line"><span class="comment"># 以守护进程模式启动</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="comment">#绑定的主机地址</span></span><br><span class="line"><span class="built_in">bind</span> `ifconfig eth0 | awk <span class="string">'NR==2&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="comment"># 监听端口</span></span><br><span class="line">port 6391</span><br><span class="line"><span class="comment"># pid 文件和 log 文件地址</span></span><br><span class="line">pidfile /var/run/redis/redis-6391.pid</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis-6391.log</span><br><span class="line"><span class="comment"># 设置数据库的数量，默认数据库为 0</span></span><br><span class="line">databases 16</span><br><span class="line"><span class="comment"># 指定本地持久化文件的文件名,默认是 dump.rdb</span></span><br><span class="line">dbfilename redis-6391.rdb</span><br><span class="line"><span class="comment"># 本地数据库的目录,默认是 ./</span></span><br><span class="line">dir /var/lib/redis</span><br><span class="line"><span class="comment"># AOF 重写</span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"redis-6391.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># 开启集群</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file cluster-6391.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis -p</span><br><span class="line">chown -R redis: /var/&#123;lib,<span class="built_in">log</span>,run&#125;/redis /etc/redis*</span><br><span class="line"></span><br><span class="line">cat &gt; /usr/lib/systemd/system/redis-6391.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis 6391</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/redis-server /etc/redis-6391.conf --supervised systemd</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/bin/redis-cli -h `ifconfig eth0 | awk <span class="string">'NR==2&#123;print $2&#125;'</span>` -p 6391 shutdown</span><br><span class="line">Type=notify</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl start redis-6391 &amp;&amp; systemctl <span class="built_in">enable</span> redis-6391</span><br><span class="line"></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster meet 10.0.0.5 6390</span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster meet 10.0.0.5 6391</span><br></pre></td></tr></table></figure>

<br>

<h3 id="使用工具扩容和收缩"><a href="#使用工具扩容和收缩" class="headerlink" title="使用工具扩容和收缩"></a>使用工具扩容和收缩</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扩容</span></span><br><span class="line"><span class="comment"># 重新分配槽位</span></span><br><span class="line">redis-cli --cluster reshard 10.0.0.5:6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次交互：需要迁移多少个槽位</span></span><br><span class="line">How many slots <span class="keyword">do</span> you want to move (from 1 to 16384)? 4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二次交互：接收槽位节点的 ID 是什么</span></span><br><span class="line">What is the receiving node ID? 6390 ID</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三次交互：哪些节点需要迁出槽位 </span></span><br><span class="line">Source node <span class="comment">#1: all</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第四次交互：确认是否执行</span></span><br><span class="line">Do you want to proceed with the proposed reshard plan (yes/no)? yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群槽位状况</span></span><br><span class="line">redis-cli --cluster info 10.0.0.5:6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 收缩</span></span><br><span class="line"><span class="comment"># 重新分配槽位</span></span><br><span class="line">redis-cli --cluster reshard 10.0.0.5 6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次交互：需要迁移多少个槽位</span></span><br><span class="line">How many slots <span class="keyword">do</span> you want to move (from 1 to 16384)? 1365</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二次交互：接收槽位节点的 ID 是什么</span></span><br><span class="line">What is the receiving node ID? 6380 ID </span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三次交互：哪些节点需要迁出槽位</span></span><br><span class="line">Source node <span class="comment">#1: 6390 ID </span></span><br><span class="line">Source node <span class="comment">#2: done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第四次交互：确认是否执行</span></span><br><span class="line">Do you want to proceed with the proposed reshard plan (yes/no)? yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重复上面的操作，直到 6390 所有的槽位都被分配出去</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查集群槽位状况</span></span><br><span class="line">redis-cli --cluster info 10.0.0.5:6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用工具删除多余节点</span></span><br><span class="line">redis-cli --cluster del-node 10.0.0.5:6390 6390 ID</span><br><span class="line">redis-cli --cluster del-node 10.0.0.5:6391 6391 ID</span><br></pre></td></tr></table></figure>

<br>

<br>

<h2 id="redis-cli–cluster-集群命令"><a href="#redis-cli–cluster-集群命令" class="headerlink" title="redis-cli–cluster 集群命令"></a>redis-cli–cluster 集群命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Cluster Manager Commands:</span><br><span class="line">  create         host1:port1 ... hostN:portN   <span class="comment"># 创建集群</span></span><br><span class="line">                 --cluster-replicas &lt;arg&gt;      <span class="comment"># 从节点个数</span></span><br><span class="line">  check          host:port                     <span class="comment"># 检查集群</span></span><br><span class="line">                 --cluster-search-multiple-owners <span class="comment"># 检查是否有槽同时被分配给了多个节点</span></span><br><span class="line">  info           host:port                     <span class="comment"># 查看集群状态</span></span><br><span class="line">  fix            host:port                     <span class="comment"># 修复集群</span></span><br><span class="line">                 --cluster-search-multiple-owners <span class="comment"># 修复槽的重复分配问题</span></span><br><span class="line">  reshard        host:port                     <span class="comment"># 指定集群的任意一节点进行迁移 slot，重新分 slots</span></span><br><span class="line">                 --cluster-from &lt;arg&gt;          <span class="comment"># 需要从哪些源节点上迁移 slot，可从多个源节点完成迁移，以逗号隔开，传递的是节点的 node id，还可以直接传递 --from all，这样源节点就是集群的所有节点，不传递该参数的话，则会在迁移过程中提示用户输入</span></span><br><span class="line">                 --cluster-to &lt;arg&gt;            <span class="comment"># slot需要迁移的目的节点的 node id，目的节点只能填写一个，不传递该参数的话，则会在迁移过程中提示用户输入</span></span><br><span class="line">                 --cluster-slots &lt;arg&gt;         <span class="comment"># 需要迁移的 slot 数量，不传递该参数的话，则会在迁移过程中提示用户输入</span></span><br><span class="line">                 --cluster-yes                 <span class="comment"># 指定迁移时的确认输入</span></span><br><span class="line">                 --cluster-timeout &lt;arg&gt;       <span class="comment"># 设置 migrate 命令的超时时间</span></span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;      <span class="comment"># 定义集群获取槽中的 key ,一次取出的 key 数量，不传的话使用默认值为 10</span></span><br><span class="line">                 --cluster-replace             <span class="comment"># 是否直接 replace 到目标节点</span></span><br><span class="line">  rebalance      host:port					 <span class="comment"># 指定集群的任意一节点进行平衡集群节点 slot 数量 </span></span><br><span class="line">                 --cluster-weight &lt;node1=w1...nodeN=wN&gt;    <span class="comment"># 指定集群节点的权重</span></span><br><span class="line">                 --cluster-use-empty-masters    <span class="comment"># 设置可以让没有分配 slot 的主节点参与，默认不允许</span></span><br><span class="line">                 --cluster-timeout &lt;arg&gt;        <span class="comment"># 设置超时时间</span></span><br><span class="line">                 --cluster-simulate             <span class="comment"># 模拟 rebalance 操作，不会真正执行迁移操作</span></span><br><span class="line">                 --cluster-pipeline &lt;arg&gt;      <span class="comment"># 定义 cluster 一次取出的 key 数量，默认值为 10</span></span><br><span class="line">                 --cluster-threshold &lt;arg&gt;     <span class="comment"># 迁移的 slot 阈值超过 threshold，执行 rebalance 操作</span></span><br><span class="line">                 --cluster-replace             <span class="comment"># 是否直接 replace 到目标节点</span></span><br><span class="line">  add-node       new_host:new_port existing_host:existing_port  <span class="comment"># 添加节点，把新节点加入到指定的集群，默认添加主节点</span></span><br><span class="line">                 --cluster-slave              <span class="comment"># 新节点作为从节点，默认随机一个主节点</span></span><br><span class="line">                 --cluster-master-id &lt;arg&gt;    <span class="comment"># 给新节点指定主节点</span></span><br><span class="line">  del-node       host:port node_id            <span class="comment"># 删除给定的一个节点，成功后关闭该节点服务</span></span><br><span class="line">  call           host:port <span class="built_in">command</span> arg arg .. arg    <span class="comment"># 在集群的所有节点执行相关命令</span></span><br><span class="line">  <span class="built_in">set</span>-timeout    host:port milliseconds		<span class="comment"># 设置 cluster-node-timeout</span></span><br><span class="line">  import         host:port                   <span class="comment"># 将外部 redis 数据导入集群</span></span><br><span class="line">                 --cluster-from &lt;arg&gt;        <span class="comment"># 将指定实例的数据导入到集群</span></span><br><span class="line">                 --cluster-copy              <span class="comment"># migrate 时指定 copy</span></span><br><span class="line">                 --cluster-replace           <span class="comment"># migrate 时指定 replace</span></span><br></pre></td></tr></table></figure>

<br>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用工具自动部署 redis 集群</span></span><br><span class="line"><span class="comment"># 1.恢复集群初始化</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 FLUSHALL</span><br><span class="line">redis-cli -h 10.0.0.6 -p 6380 FLUSHALL</span><br><span class="line">redis-cli -h 10.0.0.7 -p 6380 FLUSHALL</span><br><span class="line">redis-cli -h 10.0.0.5 -p 6381 FLUSHALL</span><br><span class="line">redis-cli -h 10.0.0.6 -p 6381 FLUSHALL</span><br><span class="line">redis-cli -h 10.0.0.7 -p 6381 FLUSHALL</span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 CLUSTER RESET</span><br><span class="line">redis-cli -h 10.0.0.6 -p 6380 CLUSTER RESET</span><br><span class="line">redis-cli -h 10.0.0.7 -p 6380 CLUSTER RESET</span><br><span class="line">redis-cli -h 10.0.0.5 -p 6381 CLUSTER RESET</span><br><span class="line">redis-cli -h 10.0.0.6 -p 6381 CLUSTER RESET</span><br><span class="line">redis-cli -h 10.0.0.7 -p 6381 CLUSTER RESET</span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 CLUSTER NODES  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.使用工具初始化</span></span><br><span class="line">redis-cli --cluster create 10.0.0.5:6380 10.0.0.6:6380 10.0.0.7:6380 10.0.0.5:90 10.0.0.5:6381 10.0.0.6:6381 10.0.0.7:6381 10.0.0.5:91 --cluster-replicas 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.检查集群</span></span><br><span class="line">redis-cli --cluster info 10.0.0.5 6380</span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 CLUSTER NODES </span><br><span class="line">redis-cli --cluster check 10.0.0.5 6380</span><br></pre></td></tr></table></figure>

<br>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模拟故障</span></span><br><span class="line"><span class="comment"># 场景：迁移数据时人为中断了，导致槽的状态不对</span></span><br><span class="line">[11213-&lt;-a69e46ea7560684a7061ddb6dc3f854a1ef3dbd4] 51</span><br><span class="line">[11213-&gt;-ccaa5dcb0f0320332100594d629122b2702660d5] 53</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用工具修复：</span></span><br><span class="line">redis-cli --cluster fix 10.0.0.51:6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动修复：</span></span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; STABLE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用工具维护集群的好处</span></span><br><span class="line">因为工具有很多判断条件，更加严谨，健壮性更好。</span><br><span class="line">删除槽，使用工具会判断，如果槽里有数据，就不执行。</span><br><span class="line">添加节点使用工具会判断，如果新增加的节点本身不为空，就不允许加入到集群。</span><br><span class="line">删除节点使用工具会判断，如果本删除节点本身还有槽，就不允许删除。</span><br></pre></td></tr></table></figure>

<br>

<h2 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.5.0 版本直接可使用自带命令迁移(需要设置密码为空才能进行导入)</span></span><br><span class="line"><span class="comment"># 将单节点 10.0.0.7:6379 的数据迁移到 10.0.0.5:6380 节点的集群 </span></span><br><span class="line"><span class="comment"># 不加 copy 参数相当于 mv 命令，旧数据迁移成功后就会消失</span></span><br><span class="line">redis-cli --cluster import 10.0.0.5:6380 --cluster-from 10.0.0.7:6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 copy 参数相当于 cp 命令，旧数据迁移成功后会保留</span></span><br><span class="line">redis-cli --cluster import 10.0.0.5:6380 --cluster-copy --cluster-from 10.0.0.7:6379 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 replace 参数会覆盖掉同名的数据，对新集群新增加的数据不受影响</span></span><br><span class="line">redis-cli --cluster import 10.0.0.5:6380 --cluster-copy --cluster-replace --cluster-from  10.0.0.7:6379 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 实验：导入一个持续有数据写入的节点</span></span><br><span class="line"><span class="comment"># 同时开 2 个终端，一个写入 key，一个执行导入命令</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..1000&#125;; <span class="keyword">do</span> redis-cli <span class="built_in">set</span> k_<span class="variable">$&#123;i&#125;</span> v_<span class="variable">$&#123;i&#125;</span>; sleep 0.2;<span class="built_in">echo</span> <span class="variable">$&#123;i&#125;</span>; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">redis-cli --cluster import 10.0.0.5:6380 --cluster-copy --cluster-replace --cluster-from  10.0.0.7:6379 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 结论：只会导入当你执行导入命令那一刻时已有的数据，类似于快照，对于后面再写入的数据不会更新</span></span><br></pre></td></tr></table></figure>

<br>

<h2 id="分析-KEY-的大小"><a href="#分析-KEY-的大小" class="headerlink" title="分析 KEY 的大小"></a>分析 KEY 的大小</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用自带工具分析</span></span><br><span class="line">redis-cli --bigkeys </span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用第三方工具分析</span></span><br><span class="line"><span class="comment"># 1.安装工具</span></span><br><span class="line">yum install python-pip gcc python-devel -y</span><br><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/sripathikrishnan/redis-rdb-tools</span><br><span class="line"><span class="built_in">cd</span> redis-rdb-tools</span><br><span class="line">pip install python-lzf</span><br><span class="line">python setup.py install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.生成测试数据</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6379 <span class="built_in">set</span> <span class="built_in">test</span> $(cat test.txt)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.执行 bgsave 生成 rdb 文件</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6379 bgsave</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.使用工具分析</span></span><br><span class="line">rdb -c memory /var/lib/redis/redis.rdb -f redis.rdb.csv</span><br><span class="line"></span><br><span class="line">5.过滤分析</span><br><span class="line">awk -F <span class="string">","</span> <span class="string">'&#123;print $4,$3&#125;'</span> redis.rdb.csv | sort -r</span><br><span class="line"></span><br><span class="line">6.将结果整理汇报给领导,询问开发这个 key 是否可以删除</span><br></pre></td></tr></table></figure>

<br>

<h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1.设置最大内存限制</span><br><span class="line">config <span class="built_in">set</span> maxmemory 2G</span><br><span class="line"></span><br><span class="line">2.内存回收机制</span><br><span class="line">生产上一定要限制 redis 的内存使用大小。</span><br><span class="line">当达到内存使用限制之后 redis 会出发对应的控制策略</span><br><span class="line">redis 支持 6 种策略：</span><br><span class="line">1.noevicition       <span class="comment"># 默认策略，不会删除任务数据，拒绝所有写入操作并返回客户端错误信息，此时只响应读操作</span></span><br><span class="line">2.volatile-lru      <span class="comment"># 根据 LRU 算法删除设置了超时属性的 key，直到留出足够空间为止，如果没有可删除的 key，则会退回到 noevicition 策略</span></span><br><span class="line">3.allkeys-lru       <span class="comment"># 根据 LRU 算法删除 key，不管数据有没有设置超时属性</span></span><br><span class="line">4.allkeys-random    <span class="comment"># 随机删除所有 key</span></span><br><span class="line">5.volatile-random   <span class="comment"># 随机删除过期 key</span></span><br><span class="line">5.volatile-ttl      <span class="comment"># 根据 key 的 ttl，删除最近要过期的 key</span></span><br><span class="line"></span><br><span class="line">3.生产上 redis 限制多大内存</span><br><span class="line">先预留系统一半内存</span><br><span class="line">48G 总内存 </span><br><span class="line">24G 系统 + 24G redis</span><br><span class="line">redis 先给 8G 内存，内存不足后，分析结果通知相关人员，排查一下是否所有的 key 都必须保留?</span><br><span class="line">redis 再给到 12G 内存，内存不足后，分析结果通知相关人员，排查一下是否所有的 key 都必须保留?</span><br><span class="line">redis 再给到 16G 内存，内存不足后，分析结果通知相关人员，排查一下是否所有的 key 都必须保留?</span><br><span class="line">等到 24G 都不够用时，汇报领导，考虑买内存了。</span><br><span class="line">等到 35G 的时候，就要考虑加内存，还是扩容机器。</span><br></pre></td></tr></table></figure>

<br>

<h2 id="集群相关命令"><a href="#集群相关命令" class="headerlink" title="集群相关命令"></a>集群相关命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以正则匹配的方式查看满足条件的 key</span></span><br><span class="line">redis-cli --scan --pattern <span class="string">'k*'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群各节点状态</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 CLUSTER NODES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置集群中的复制关系</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6381 cluster replicate 32ff53a704b8b948a75378402205fe9aeec8bcfb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加槽位</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster addslots &#123;0..5460&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动修复指定的槽位</span></span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; STABLE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 平衡集群中各个节点的 slot 数量</span></span><br><span class="line">redis-cli --cluster rebalance 10.0.0.5 6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除集群节点</span></span><br><span class="line">redis-cli --cluster del-node 10.0.0.5:6390 节点(6390)ID</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修复集群</span></span><br><span class="line">redis-cli --cluster fix 10.0.0.5:6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空集群信息</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster reset</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster info</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line">redis-cli --cluster info 10.0.0.5 6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行集群检查</span></span><br><span class="line">redis-cli --cluster check 10.0.0.5 6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入节点到集群</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster meet 10.0.0.7 6381</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新分配槽位</span></span><br><span class="line">redis-cli --cluster reshard 10.0.0.5:6380</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主动发起集群角色切换</span></span><br><span class="line">redis-cli -h 10.0.0.5 -p 6380 cluster failover</span><br></pre></td></tr></table></figure>
</div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/redis/">redis</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/03/20/Python%20%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/"><img class="prev_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Python 基础入门</div></div></a></div><div class="next-post pull_right"><a href="/2018/02/13/Zabbix%20%E7%9B%91%E6%8E%A7/"><img class="next_cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Zabbix 监控</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By ALAN</div><div class="footer_custom_text">yuiya@yahoo.com</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode far fa-sun" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script></body></html>